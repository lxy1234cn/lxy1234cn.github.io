<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>在AspNetCore中理解依赖注入生命周期冲突</title>
      <link href="/2025/12/12/%E5%9C%A8AspNetCore%E4%B8%AD%E7%90%86%E8%A7%A3%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%86%B2%E7%AA%81/"/>
      <url>/2025/12/12/%E5%9C%A8AspNetCore%E4%B8%AD%E7%90%86%E8%A7%A3%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%86%B2%E7%AA%81/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="在AspNetCore中理解依赖注入生命周期冲突"><a href="#在AspNetCore中理解依赖注入生命周期冲突" class="headerlink" title="在AspNetCore中理解依赖注入生命周期冲突"></a>在AspNetCore中理解依赖注入生命周期冲突</h1><p>在 ASP.NET Core 的日常开发中，依赖注入（Dependency Injection, DI）几乎是贯穿所有功能的核心技术。而在学习 DI 时，<br>一个非常重要但又容易被忽略的问题就是 服务生命周期（Service Lifetime）之间的冲突。</p><p>这篇文章通过一个简单的 后台托管服务（BackgroundService） 示例，来展示不同生命周期的服务在注入时会出现什么问题，以及如何正确解决这种冲突。</p><h2 id="生命周期的三种类型"><a href="#生命周期的三种类型" class="headerlink" title="生命周期的三种类型"></a>生命周期的三种类型</h2><p>在 ASP.NET Core 中，服务的生命周期有三种类型：</p><ol><li>Transient：每次请求都会创建一个新的实例</li><li>Scoped：每次请求都会创建一个新的实例，但同一个请求中的不同控制器会共享同一个实例</li><li>Singleton：整个应用程序中只有一个实例，所有请求都会共享这个实例</li></ol><p>而后台托管服务（BackgroundService）是 ASP.NET Core 中用于在后台运行异步任务的抽象基类。<br>本文中选择它为案例是因为后台托管任务的生命周期是singleton。</p><h2 id="依赖注入的常用方式"><a href="#依赖注入的常用方式" class="headerlink" title="依赖注入的常用方式"></a>依赖注入的常用方式</h2><p>在 ASP.NET Core 中，依赖注入的常用方式有三种：</p><ol><li><p>构造函数注入（Constructor Injection）</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHostedService</span> : <span class="title">BackgroundService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;TestHostedService&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IIdGenService _idGenService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">ILogger&lt;TestHostedService&gt; logger, IIdGenService idGenService</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">        _idGenService = idGenService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>属性注入（Property Injection）<br>在注册服务时，需要使用 ActivatorUtilities 或 ConfigureServices 配置 才能给它写入属性</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> ILogger&lt;MyService&gt;? Logger &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DoWork</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Logger?.LogInformation(<span class="string">&quot;Working...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>方法注入（Method Injection）</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params">[FromServices] IIdGenService idGenService</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> id = idGenService.NewGuid();</span><br><span class="line">        <span class="keyword">return</span> Ok(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><p>其中构造函数注入和属性注入是比较常见的，而方法注入则比较少见。建议使用构造函数注入，因为它更方便，更安全。<br>方法和属性注入在这里就是补充说明一下，因为它们的使用场景比较少，所以这里就不再深入讲解了。</p><h2 id="示例代码：一个依赖-IdGenService-的后台定时任务"><a href="#示例代码：一个依赖-IdGenService-的后台定时任务" class="headerlink" title="示例代码：一个依赖 IdGenService 的后台定时任务"></a>示例代码：一个依赖 IdGenService 的后台定时任务</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHostedService</span> : <span class="title">BackgroundService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;TestHostedService&gt; _logger;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IIdGenService _idGenService;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _executionCount;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">ILogger&lt;TestHostedService&gt; logger, IIdGenService idGenService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger = logger;</span><br><span class="line">            _idGenService = idGenService;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ExecuteAsync</span>(<span class="params">CancellationToken stoppingToken</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务启动.&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> DoWork();</span><br><span class="line">            <span class="keyword">using</span> PeriodicTimer timer = <span class="keyword">new</span>(TimeSpan.FromSeconds(<span class="number">10</span>));</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">await</span> timer.WaitForNextTickAsync(stoppingToken))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> DoWork();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (OperationCanceledException)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogInformation(<span class="string">&quot;定时托管服务已停止.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoWork</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> id = <span class="keyword">await</span> _idGenService.NewGuidAsync(<span class="number">5</span>);</span><br><span class="line">            _logger.LogInformation(<span class="string">$&quot;生成Id: <span class="subst">&#123;id&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="built_in">int</span> count = Interlocked.Increment(<span class="keyword">ref</span> _executionCount);</span><br><span class="line">            <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">2</span>));</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务运行 &#123;Count&#125;&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Program.cs中注册服务</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddHostedService&lt;TestHostedService&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//builder.Services.AddTransient&lt;IIdGenService, IdGenService&gt;();</span></span><br><span class="line"><span class="comment">//builder.Services.AddScoped&lt;IIdGenService, IdGenService&gt;();</span></span><br><span class="line"><span class="comment">//builder.Services.AddSingleton&lt;IIdGenService, IdGenService&gt;();</span></span><br></pre></td></tr></table></figure><p>在这段代码中，我们注册了后台托管服务 TestHostedService，并使用不同的生命周期类型注册了 IdGenService。<br>重点是 IIdGenService 的生命周期不同会带来不同效果。</p><p>我们先分别解除注释，看看使用情况：</p><p>解除 Scoped 的注释<br>出现了报错<br>运行截图：</p><p><img src="https://origin.picgo.net/2025/12/12/ghjnd0a7c2e18d64de960.png" alt="ghjnd"></p><p>核心原因是：ASP.NET Core 的 后台托管服务（HostedService）默认是 Singleton（单例）DI 不允许 生命周期长的服务依赖生命周期短的服务<br>因为这会产生所谓的：捕获（capture）一个比自身短生命周期的依赖，可能导致依赖被提前销毁或状态错误。<br>例如在后台托管服务中直接注入DbContext，就会出现这种情况。因为DbContext的生命周期默认是Scoped，而导致后台托管服务在使用完这一个DbContext后，却还一直持有，<br>占用数据库连接，导致数据库连接池耗尽。</p><blockquote><p>Singleton 服务 在整个程序生命周期都活着，它不能依赖随时都可能被释放的 Transient 或 Scoped 服务。</p></blockquote><p>然后我们把Scoped注释掉，再解除Singleton的注释<br>发现正常运行：<br>运行截图：</p><p><img src="https://origin.picgo.net/2025/12/12/sbfvr9403b42e7e8c3420.png" alt="sbfvr"></p><p>因为这时IdGenService是与托管服务TestHostedService是同一个生命周期，所以没有问题。</p><p>上面说了，长的生命周期不允许依赖短的生命周期，那我们猜一下解除 Transient 的注释会发生什么？<br>运行截图：</p><p><img src="https://origin.picgo.net/2025/12/12/sdfhbk4eb244c3993d2806.png" alt="sdfhbk"></p><p>(⊙o⊙)？不对，怎么是正常的？<br>我去查了一下：在ASP.NET Core 的 DI 系统中，Transient 是不受生命周期“捕获”规则限制的。</p><p>微软官方定义如下（简化）：</p><blockquote><p>Transient 服务每次请求都会重新创建，容器允许它被任何生命周期的服务注入。</p></blockquote><p>也就是说：</p><p>. Transient 本身没有“作用域”</p><p>. 它也不依赖容器来管理生命周期</p><p>. 所以不会产生“被提前释放”的风险</p><p>因此：<br> 单例依赖 Transient 是安全的（没有生命周期冲突）</p><h2 id="那为什么大家都以为-Transient-会报错？"><a href="#那为什么大家都以为-Transient-会报错？" class="headerlink" title="那为什么大家都以为 Transient 会报错？"></a>那为什么大家都以为 Transient 会报错？</h2><p>因为很多教程、中文文章、视频讲解都把 Scoped 和 Transient 混在一起，以为这两者都「生命周期短 → 都不能给单例用」。</p><p>但实际情况是：</p><table><thead><tr><th>生命周期</th><th>是否允许被 Singleton 依赖？</th><th>原因</th></tr></thead><tbody><tr><td>Singleton</td><td>✔</td><td>同生命周期 &#x2F; 更长</td></tr><tr><td>Transient</td><td>✔</td><td>不依赖 Scope，由容器直接 new</td></tr><tr><td>Scoped</td><td>❌</td><td>必须在 Scope 内创建（Http Request）</td></tr></tbody></table><h2 id="那如果我们非要在-Singleton-中注入-Scoped-呢？"><a href="#那如果我们非要在-Singleton-中注入-Scoped-呢？" class="headerlink" title="那如果我们非要在 Singleton 中注入 Scoped 呢？"></a>那如果我们非要在 Singleton 中注入 Scoped 呢？</h2><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>使用 using 和  IServiceScopeFactory 来创建一个临时的 Scoped 作用域</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHostedService</span> : <span class="title">BackgroundService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;TestHostedService&gt; _logger;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceScopeFactory _serviceScopeFactory;<span class="comment">//看这里</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _executionCount;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">ILogger&lt;TestHostedService&gt; logger, IServiceScopeFactory serviceScopeFactory</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger = logger;</span><br><span class="line">            _serviceScopeFactory = serviceScopeFactory;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ExecuteAsync</span>(<span class="params">CancellationToken stoppingToken</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务启动.&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> DoWork();</span><br><span class="line">            <span class="keyword">using</span> PeriodicTimer timer = <span class="keyword">new</span>(TimeSpan.FromSeconds(<span class="number">10</span>));</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">await</span> timer.WaitForNextTickAsync(stoppingToken))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> DoWork();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (OperationCanceledException)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogInformation(<span class="string">&quot;定时托管服务已停止.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoWork</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//看这里</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;using和IServiceScopeFactory&gt;</span></span></span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> scope = _serviceScopeFactory.CreateScope();</span><br><span class="line">            <span class="keyword">var</span> dateContext = scope.ServiceProvider.GetRequiredService&lt;DateContext&gt;();</span><br><span class="line">            <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;using和IServiceScopeFactory/&gt;</span></span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> toDoList = <span class="keyword">await</span> dateContext.ToDoListTable</span><br><span class="line">                .Include(t =&gt; t.TransactionNodes)</span><br><span class="line">                .FirstOrDefaultAsync(x =&gt; x.Id == <span class="string">&quot;1ca&quot;</span>);</span><br><span class="line"></span><br><span class="line">            _logger.LogInformation(<span class="string">$&quot;ToDoList Id:<span class="subst">&#123;toDoList.Id&#125;</span>, Title:<span class="subst">&#123;toDoList.ListTitle&#125;</span>, Description:<span class="subst">&#123;toDoList.ListDescription&#125;</span>, State:<span class="subst">&#123;toDoList.State&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> toDoList.TransactionNodes)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogInformation(<span class="string">$&quot;TransactionNode Id:<span class="subst">&#123;item.Id&#125;</span>, SerialNumber:<span class="subst">&#123;item.SerialNumber&#125;</span>, Content:<span class="subst">&#123;item.Content&#125;</span>, State:<span class="subst">&#123;item.State&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">int</span> count = Interlocked.Increment(<span class="keyword">ref</span> _executionCount);</span><br><span class="line">            <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">2</span>));</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务运行 &#123;Count&#125;&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就解决了，运行截图：</p><p><img src="https://origin.picgo.net/2025/12/12/aishdbvcec71955ade1c8fc7.png" alt="aishdbvc"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在AspNetCore中简单使用EFcore的一对多关系</title>
      <link href="/2025/12/11/%E5%9C%A8AspNetCore%E4%B8%AD%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8EFcore%E7%9A%84%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB/"/>
      <url>/2025/12/11/%E5%9C%A8AspNetCore%E4%B8%AD%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8EFcore%E7%9A%84%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="在AspNetCore中简单使用EFcore的一对多关系"><a href="#在AspNetCore中简单使用EFcore的一对多关系" class="headerlink" title="在AspNetCore中简单使用EFcore的一对多关系"></a>在AspNetCore中简单使用EFcore的一对多关系</h1><p>我们将创建一个简单的示例。<br>准备两个模型：</p><ol><li>待办事务列表（TodoList）<br>一个待办事务列表包含多个事务节点。</li><li>事务节点 （TransactionNode）<br>每个事务节点属于一个待办事务列表。</li></ol><h2 id="待办事务列表（TodoList）模型："><a href="#待办事务列表（TodoList）模型：" class="headerlink" title="待办事务列表（TodoList）模型："></a>待办事务列表（TodoList）模型：</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations.Schema;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ToDoList</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        [<span class="meta">DatabaseGenerated(DatabaseGeneratedOption.None)</span>]<span class="comment">// 关闭自动生成主键,使用手动赋值</span></span><br><span class="line">        [<span class="meta">MaxLength(50)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ListTitle &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ListDescription &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? State &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;TransactionNode&gt;? TransactionNodes &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">//导航属性，用于访问与此待办事务列表相关联的事务节点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="事务节点（TransactionNode）模型："><a href="#事务节点（TransactionNode）模型：" class="headerlink" title="事务节点（TransactionNode）模型："></a>事务节点（TransactionNode）模型：</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations.Schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TransactionNode</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        [<span class="meta">DatabaseGenerated(DatabaseGeneratedOption.None)</span>]</span><br><span class="line">        [<span class="meta">MaxLength(50)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? SerialNumber &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> ToDoList? ToDoList &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">//导航属性，用于访问与此事务节点相关联的待办事务列表, 有时也叫引用类型</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? State &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">//0:未完成 1:完成</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="配置数据库上下文（DbContext）："><a href="#配置数据库上下文（DbContext）：" class="headerlink" title="配置数据库上下文（DbContext）："></a>配置数据库上下文（DbContext）：</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DateContext</span>:<span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DateContext</span>(<span class="params">DbContextOptions&lt;DateContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;ToDoList&gt; ToDoListTable &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;TransactionNode&gt; TransactionNodeTable &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="为模型类进行配置："><a href="#为模型类进行配置：" class="headerlink" title="为模型类进行配置："></a>为模型类进行配置：</h2><p>TodoList和TransactionNode之间的一对多关系可以通过导航属性进行配置。EF Core会自动识别这种关系。<br>ToDoList:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ToDoListConfig</span>: <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">ToDoList</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder&lt;ToDoList&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;ToDoListTable&quot;</span>);</span><br><span class="line">            builder.Property(a =&gt; a.ListTitle).HasMaxLength(<span class="number">50</span>);</span><br><span class="line">            builder.Property(a =&gt; a.ListDescription).HasMaxLength(<span class="number">250</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>TransactionNode:<br>注意这里的HasOne和WithMany的使用</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TransactionNodeConfig</span>:<span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">TransactionNode</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">Microsoft.EntityFrameworkCore.Metadata.Builders.EntityTypeBuilder&lt;TransactionNode&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;TransactionNodeTable&quot;</span>);</span><br><span class="line">            <span class="comment">//重点看这里的一对多关系配置，注意HasOne和WithMany的使用</span></span><br><span class="line">            builder.HasOne&lt;ToDoList&gt;(a =&gt; a.ToDoList).WithMany(c =&gt; c.TransactionNodes).IsRequired();</span><br><span class="line">            builder.Property(a =&gt; a.Content).HasMaxLength(<span class="number">250</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>program.cs中配置DbContext：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddDbContext&lt;DateContext&gt;(options =&gt;</span><br><span class="line">    options.UseSqlServer(builder.Configuration.GetConnectionString(<span class="string">&quot;DefaultConnection&quot;</span>))</span><br><span class="line">    );</span><br></pre></td></tr></table></figure><h2 id="在控制器中使用："><a href="#在控制器中使用：" class="headerlink" title="在控制器中使用："></a>在控制器中使用：</h2><p>添加数据：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; Test01_AddData()</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">var</span> toDolist01 = <span class="keyword">new</span> ToDoList()</span><br><span class="line">     &#123;</span><br><span class="line">         Id = <span class="keyword">await</span> _idGenService.NewGuidAsync(<span class="number">3</span>),</span><br><span class="line">         ListTitle = <span class="string">&quot;List02&quot;</span>,</span><br><span class="line">         ListDescription = <span class="string">&quot;List02_Description&quot;</span>,</span><br><span class="line">         State = <span class="string">&quot;0&quot;</span>,</span><br><span class="line">         <span class="comment">//这里需要初始化TransactionNodes,不然后面 toDolist01.TransactionNodes.Add会报错</span></span><br><span class="line">         <span class="comment">//, if (toDolist01 == null)拦不住transactionNodes不为null,因为toDolist01不为null,只是TransactionNodes为null而已</span></span><br><span class="line">         <span class="comment">//所以要判断TransactionNodes是否为null,而不是toDolist01是否为null</span></span><br><span class="line">         TransactionNodes = <span class="keyword">new</span> List&lt;TransactionNode&gt;()</span><br><span class="line">     &#125;;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//if (toDolist01 == null) </span></span><br><span class="line">     <span class="comment">//&#123; </span></span><br><span class="line">     <span class="comment">//    return await Task.FromResult(&quot;toDolist01 is null&quot;);</span></span><br><span class="line">     <span class="comment">//&#125;</span></span><br><span class="line">     </span><br><span class="line">     <span class="keyword">if</span> (toDolist01.TransactionNodes == <span class="literal">null</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">await</span> Task.FromResult(<span class="string">&quot;toDolist01.TransactionNodes is null&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">var</span> transactionNode01 = <span class="keyword">new</span> TransactionNode()</span><br><span class="line">     &#123;</span><br><span class="line">         Id = <span class="keyword">await</span> _idGenService.NewGuidAsync(<span class="number">3</span>),</span><br><span class="line">         SerialNumber = <span class="string">&quot;01&quot;</span>,</span><br><span class="line">         State = <span class="string">&quot;0&quot;</span>,</span><br><span class="line">         Content = <span class="string">&quot;Content02x01&quot;</span>,</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">var</span> transactionNode02 = <span class="keyword">new</span> TransactionNode()</span><br><span class="line">     &#123;</span><br><span class="line">         Id = <span class="keyword">await</span> _idGenService.NewGuidAsync(<span class="number">3</span>),</span><br><span class="line">         SerialNumber = <span class="string">&quot;02&quot;</span>,</span><br><span class="line">         State = <span class="string">&quot;0&quot;</span>,</span><br><span class="line">         Content = <span class="string">&quot;Content02x02&quot;</span>,</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">var</span> transactionNode03 = <span class="keyword">new</span> TransactionNode()</span><br><span class="line">     &#123;</span><br><span class="line">         Id = <span class="keyword">await</span> _idGenService.NewGuidAsync(<span class="number">3</span>),</span><br><span class="line">         SerialNumber = <span class="string">&quot;03&quot;</span>,</span><br><span class="line">         State = <span class="string">&quot;0&quot;</span>,</span><br><span class="line">         Content = <span class="string">&quot;Content02x03&quot;</span>,</span><br><span class="line">     &#125;;</span><br><span class="line">     toDolist01.TransactionNodes.Add(transactionNode01);</span><br><span class="line">     toDolist01.TransactionNodes.Add(transactionNode02);</span><br><span class="line">     toDolist01.TransactionNodes.Add(transactionNode03);</span><br><span class="line">     <span class="keyword">await</span> _dateContext.ToDoListTable.AddAsync(toDolist01);</span><br><span class="line">     <span class="keyword">await</span> _dateContext.SaveChangesAsync();</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">await</span> Task.FromResult(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>添加数据其实只要注意一下要初始化导航属性的集合就行了，比如上面的TransactionNodes。</p><p>查询数据：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; Test01_GetData()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//firstOrDefaultAsync是链式调用IQueryable</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注意这里</span></span><br><span class="line">    <span class="comment">// 把子表一并查出,没加 .Include(t =&gt; t.TransactionNodes),导航属性,懒加载不会触发</span></span><br><span class="line">    <span class="keyword">var</span> toDoList = <span class="keyword">await</span> _dateContext.ToDoListTable</span><br><span class="line">           .Include(t =&gt; t.TransactionNodes)   </span><br><span class="line">           .FirstOrDefaultAsync(x =&gt; x.Id == <span class="string">&quot;84c&quot;</span>);</span><br><span class="line">    <span class="comment">//如果不加Include,导航属性TransactionNodes为null,但就算是这样if (toDoList == null)也不会触发原因同上，</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//因为toDoList不为null,还是会通过</span></span><br><span class="line">    <span class="comment">//if (toDoList == null)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    Console.WriteLine(&quot;toDoList is null&quot;);</span></span><br><span class="line">    <span class="comment">//    return await Task.FromResult(&quot;toDoList is null&quot;);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (toDoList.TransactionNodes == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;toDoList.TransactionNodes is null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> Task.FromResult(<span class="string">&quot;toDoList.TransactionNodes is null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    _logger.LogInformation(<span class="string">$&quot;ToDoList Id:<span class="subst">&#123;toDoList.Id&#125;</span>, Title:<span class="subst">&#123;toDoList.ListTitle&#125;</span>, Description:<span class="subst">&#123;toDoList.ListDescription&#125;</span>, State:<span class="subst">&#123;toDoList.State&#125;</span>&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> toDoList.TransactionNodes)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">$&quot;TransactionNode Id:<span class="subst">&#123;item.Id&#125;</span>, SerialNumber:<span class="subst">&#123;item.SerialNumber&#125;</span>, Content:<span class="subst">&#123;item.Content&#125;</span>, State:<span class="subst">&#123;item.State&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> Task.FromResult(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在查询数据时，注意使用.Include方法来加载导航属性，以确保相关的事务节点也被加载。</p><p>查询数据运行截图：<br><img src="https://origin.picgo.net/2025/12/11/iusdbf40be627af0e53be9.png" alt="iusdbf"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在AspNetCore中使用托管服务</title>
      <link href="/2025/12/10/%E5%9C%A8AspNetCore%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%89%98%E7%AE%A1%E6%9C%8D%E5%8A%A1/"/>
      <url>/2025/12/10/%E5%9C%A8AspNetCore%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%89%98%E7%AE%A1%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="在AspNetCore中使用托管服务"><a href="#在AspNetCore中使用托管服务" class="headerlink" title="在AspNetCore中使用托管服务"></a>在AspNetCore中使用托管服务</h1><h2 id="是托管服务主要用于什么场景？"><a href="#是托管服务主要用于什么场景？" class="headerlink" title="是托管服务主要用于什么场景？"></a>是托管服务主要用于什么场景？</h2><p>托管服务主要用于那些不便于运行在前台，不便于写在控制器中的代码。比如服务器启动的时候在后台预先加载数据到缓存，<br>每天凌晨3点把数据导出到备份数据库，每隔5秒在两张表之间同步一些数据，定时清理过期数据等等。</p><h2 id="如何使用托管服务？"><a href="#如何使用托管服务？" class="headerlink" title="如何使用托管服务？"></a>如何使用托管服务？</h2><p>托管服务有两种实现方式：</p><ol><li>创建一个类实现IHostedService接口，这个方法完全自定义，需要注意生命周期管理，然后还要实现两个方法<br>StartAsync(),StopAsync()最后在Program.cs中把服务注册到依赖注入容器。真心不建议使用这个</li></ol><p>案例：使用IHostedService创建一个定时任务，每隔10秒执行一次，每次执行的任务是打印当前时间。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">HostedService_AspNetCore01x02</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHostedService</span> : <span class="title">IHostedService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;TestHostedService&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> Timer _timer;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _executionCount;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">ILogger&lt;TestHostedService&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StartAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;定时托管服务启动.&quot;</span>);</span><br><span class="line">        _timer = <span class="keyword">new</span> Timer(DoWork, <span class="literal">null</span>, TimeSpan.Zero, TimeSpan.FromSeconds(<span class="number">10</span>));</span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DoWork</span>(<span class="params"><span class="built_in">object</span> state</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> count = Interlocked.Increment(<span class="keyword">ref</span> _executionCount);</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;定时托管服务运行 &#123;Count&#125;&quot;</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">StopAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;定时托管服务已停止.&quot;</span>);</span><br><span class="line">        _timer?.Change(Timeout.Infinite, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Program.cs中注册服务</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddHostedService&lt;TestHostedService&gt;();</span><br></pre></td></tr></table></figure><p>运行截图：<br><img src="https://origin.picgo.net/2025/12/10/okjsnvaw35f8bca3b3a7b0f7.png" alt="okjsnvaw"></p><ol start="2"><li>创建一个类，然后继承BackgroundService类，BackgroundService是官方提供的实现了IHostedService接口的抽象类。<br>然后去重写ExecuteAsync()方法，这个方法用于定义任务逻辑。这个方法同样需要在Program.cs中把服务注册到依赖注入容器。<br>使用BackgroundService的优势是它会自动管理生命周期，不需要自己去管理。推荐使用这个，问就是方便！！！</li></ol><p>案例：使用BackgroundService创建一个定时任务，每隔10秒执行一次，每次执行的任务是打印当前时间。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">HostedService_AspNetCore01x02</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHostedService</span> : <span class="title">BackgroundService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;TestHostedService&gt; _logger;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _executionCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">ILogger&lt;TestHostedService&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ExecuteAsync</span>(<span class="params">CancellationToken stoppingToken</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;定时托管服务启动.&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> DoWork();</span><br><span class="line">        <span class="keyword">using</span> PeriodicTimer timer = <span class="keyword">new</span>(TimeSpan.FromSeconds(<span class="number">10</span>));<span class="comment">//可以在这里改时间间隔，秒，分，时，天</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">await</span> timer.WaitForNextTickAsync(stoppingToken))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> DoWork();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (OperationCanceledException)</span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务已停止.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoWork</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> count = Interlocked.Increment(<span class="keyword">ref</span> _executionCount);</span><br><span class="line">        <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">2</span>));</span><br><span class="line">        _logger.LogInformation(<span class="string">&quot;定时托管服务运行 &#123;Count&#125;&quot;</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Program.cs中注册服务</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddHostedService&lt;TestHostedService&gt;();</span><br></pre></td></tr></table></figure><p>运行截图：<br><img src="https://origin.picgo.net/2025/12/10/ajgdsherfc956eb7c0cd02523.png" alt="ajgdsherf"><br>这就是一个简单的定时任务，每隔10秒执行一次，每次执行的任务是打印当前时间，注意这个托管服务我没有注入Scoped服务。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><pre><code>除了这些，在使用托管服务的时候需要注意生命周期的冲突。</code></pre><p>我们都知道托管服务是Singleton服务，而DbContext是Scoped服务。<br>所以直接把DbContext依赖注入到托管服务中会报错。<br>因为DbContext本来是在一个作用域（如一次 HTTP 请求、一个手动 CreateScope）内创建，作用域结束时自动释放;<br>但托管服务是单例周期会一直存在，导致托管服务会一直持有这一个DbContext而不会释放，一直到进程退出，<br>这就是连接泄漏、内存泄漏的根源。</p><h2 id="如何在托管服务中使用DbContext？"><a href="#如何在托管服务中使用DbContext？" class="headerlink" title="如何在托管服务中使用DbContext？"></a>如何在托管服务中使用DbContext？</h2><p>同时使用 using 和 IServiceScopeFactory： </p><ol><li>使用IServiceScopeFactory提供“临时作用域”对象，让 Scoped 的 DbContext 能被正确解析出来。</li><li>使用using确保作用域结束时自动 Dispose（归还连接、清缓存）。</li></ol><p>关键处代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IServiceScopeFactory _serviceScopeFactory;</span><br><span class="line"><span class="comment">// 构造函数，把IServiceScopeFactory注入到托管服务中</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">IServiceScopeFactory serviceScopeFactory</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _serviceScopeFactory = serviceScopeFactory;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定时任务逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoWork</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用IServiceScopeFactory来创建一个新的作用域，然后在作用域内注入DbContext</span></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">var</span> scope = _serviceScopeFactory.CreateScope();</span><br><span class="line">    <span class="keyword">var</span> dateContext = scope.ServiceProvider.GetRequiredService&lt;DateContext&gt;();</span><br><span class="line">    <span class="comment">// 查询数据库的逻辑</span></span><br><span class="line">    <span class="keyword">var</span> toDoList = <span class="keyword">await</span> dateContext.ToDoListTable</span><br><span class="line">    <span class="comment">//注意：这里也是一个要点，在一对多关系的查询中非常重要：EF Core 默认不延迟加载；不加 Include 就得不到导航数据。</span></span><br><span class="line">        .Include(t =&gt; t.TransactionNodes)</span><br><span class="line">        .FirstOrDefaultAsync(x =&gt; x.Id == <span class="string">&quot;1ca&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整代码(这是一个一对多的事务列表及其事务节点的查询，这只是一个随便写的案例)：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestEFc_IEQable_AspNetCore01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHostedService</span>:<span class="title">BackgroundService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;TestHostedService&gt; _logger;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IServiceScopeFactory _serviceScopeFactory;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _executionCount;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestHostedService</span>(<span class="params">ILogger&lt;TestHostedService&gt; logger, IServiceScopeFactory serviceScopeFactory</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger = logger;</span><br><span class="line">            _serviceScopeFactory = serviceScopeFactory;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">ExecuteAsync</span>(<span class="params">CancellationToken stoppingToken</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务启动.&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> DoWork();</span><br><span class="line">            <span class="keyword">using</span> PeriodicTimer timer = <span class="keyword">new</span>(TimeSpan.FromSeconds(<span class="number">10</span>));</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">await</span> timer.WaitForNextTickAsync(stoppingToken))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> DoWork();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (OperationCanceledException)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogInformation(<span class="string">&quot;定时托管服务已停止.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task <span class="title">DoWork</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> <span class="keyword">var</span> scope = _serviceScopeFactory.CreateScope();</span><br><span class="line">            <span class="keyword">var</span> dateContext = scope.ServiceProvider.GetRequiredService&lt;DateContext&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> toDoList = <span class="keyword">await</span> dateContext.ToDoListTable</span><br><span class="line">                .Include(t =&gt; t.TransactionNodes)</span><br><span class="line">                .FirstOrDefaultAsync(x =&gt; x.Id == <span class="string">&quot;1ca&quot;</span>);</span><br><span class="line">            <span class="comment">//这里忘了加判空了，有时候可能返回 null，但是也能用</span></span><br><span class="line">            _logger.LogInformation(<span class="string">$&quot;ToDoList Id:<span class="subst">&#123;toDoList.Id&#125;</span>, Title:<span class="subst">&#123;toDoList.ListTitle&#125;</span>, Description:<span class="subst">&#123;toDoList.ListDescription&#125;</span>, State:<span class="subst">&#123;toDoList.State&#125;</span>&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> toDoList.TransactionNodes)</span><br><span class="line">            &#123;</span><br><span class="line">                _logger.LogInformation(<span class="string">$&quot;TransactionNode Id:<span class="subst">&#123;item.Id&#125;</span>, SerialNumber:<span class="subst">&#123;item.SerialNumber&#125;</span>, Content:<span class="subst">&#123;item.Content&#125;</span>, State:<span class="subst">&#123;item.State&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">int</span> count = Interlocked.Increment(<span class="keyword">ref</span> _executionCount);</span><br><span class="line">            <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">2</span>));</span><br><span class="line">            _logger.LogInformation(<span class="string">&quot;定时托管服务运行 &#123;Count&#125;&quot;</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行截图：<br><img src="https://origin.picgo.net/2025/12/10/hdhva29ae6a15df6c1c0b.png" alt="hdhva"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在EFcore中IEnumerable与IQueryable的区别</title>
      <link href="/2025/12/09/%E5%9C%A8EFcore%E4%B8%ADIEnumerable%E4%B8%8EIQueryable%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
      <url>/2025/12/09/%E5%9C%A8EFcore%E4%B8%ADIEnumerable%E4%B8%8EIQueryable%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="在EFcore中IEnumerable与IQueryable的区别"><a href="#在EFcore中IEnumerable与IQueryable的区别" class="headerlink" title="在EFcore中IEnumerable与IQueryable的区别"></a>在EFcore中IEnumerable与IQueryable的区别</h1><p>  IQueryable 是 IEnumerable 的子类，所以 IQueryable 可以被转换为 IEnumerable，但是 IEnumerable 不可以被转换为 IQueryable。<br>IQueryable 是延迟执行的，也就是说，它不会立即执行，而是在调用 ToList()、ToArray() 等方法时才执行；而IEnumerable 是立即执行的。<br>同时Queryable中的where方法会返回一个IQueryable对象，而Enumerable中的where方法会返回一个IEnumerable对象。<br>但它们最主要的区别是一个是服务端评估，一个是客户端评估。</p><hr><p>IEnumerable 是客户端评估，即在客户端执行，如果你要查询一条数据，而这个数据表里面一共有100万条数据，那么IEnumerable会把所有数据都拉下来，<br>然后在内存中过滤，CPU 和 GC 都会飙升，这样效率就很低了。<br>而 IQueryable 是服务端评估，即在使用SQL语句在数据库服务器上完成数据筛选，仅把最终结果返回给查询方。</p><h3 id="IEnumerable-端"><a href="#IEnumerable-端" class="headerlink" title="IEnumerable 端"></a>IEnumerable 端</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; TestIEnumerableAsync_Select(<span class="built_in">string</span> id)</span><br><span class="line">&#123;</span><br><span class="line">    IEnumerable&lt;TestTable01&gt; seq = _dateContext.TestTable01s;</span><br><span class="line">    <span class="keyword">var</span> list = seq.Where(x =&gt; x.Id == id)  </span><br><span class="line">                  .ToList();<span class="comment">//注意这里，需要ToList()，否则不会执行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">$&quot;ok <span class="subst">&#123;list.Count&#125;</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IQueryable-端"><a href="#IQueryable-端" class="headerlink" title="IQueryable 端"></a>IQueryable 端</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; TestIQueryableAsync_Select(<span class="built_in">string</span> id)</span><br><span class="line">&#123;</span><br><span class="line">    IQueryable&lt;TestTable01&gt; seq = _dateContext.TestTable01s;</span><br><span class="line">    <span class="keyword">var</span> list = seq.Where(x =&gt; x.Id == id)   </span><br><span class="line">                   .ToListAsync();           </span><br><span class="line">    <span class="keyword">return</span> <span class="string">$&quot;ok <span class="subst">&#123;list.Result.Count&#125;</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>目的</th><th>IQueryable 推荐</th><th>IEnumerable 备注</th></tr></thead><tbody><tr><td>取第一条</td><td>FirstOrDefaultAsync(…)</td><td>无异步版本</td></tr><tr><td>统计</td><td>CountAsync(…)</td><td>全表拉回再 Count()</td></tr><tr><td>是否存在</td><td>AnyAsync(…)</td><td>全表拉回再 Any()</td></tr></tbody></table><blockquote><p>其实我觉得大多数人用的应该都是FirstOrDefaultAsync(…)这个方法吧，毕竟这个挺方便的。</p></blockquote><h3 id="控制台截图（如果图床崩了加载不出来可以看文字）"><a href="#控制台截图（如果图床崩了加载不出来可以看文字）" class="headerlink" title="控制台截图（如果图床崩了加载不出来可以看文字）"></a>控制台截图（如果图床崩了加载不出来可以看文字）</h3><p><img src="https://origin.picgo.net/2025/12/09/ajhsvb7c6154cc68867d45.png" alt="ajhsvb"></p><h3 id="IEnumerable控制台输出"><a href="#IEnumerable控制台输出" class="headerlink" title="IEnumerable控制台输出"></a>IEnumerable控制台输出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class="line">      Executed DbCommand (21ms) [Parameters=[], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      SELECT [t].[Id], [t].[Data]</span><br><span class="line">      FROM [TestTable01s] AS [t]</span><br></pre></td></tr></table></figure><h3 id="IQueryable控制台输出"><a href="#IQueryable控制台输出" class="headerlink" title="IQueryable控制台输出"></a>IQueryable控制台输出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">info: Microsoft.EntityFrameworkCore.Database.Command[20101]</span><br><span class="line">      Executed DbCommand (33ms) [Parameters=[@__id_0=&#x27;?&#x27; (Size = 50)], CommandType=&#x27;Text&#x27;, CommandTimeout=&#x27;30&#x27;]</span><br><span class="line">      SELECT [t].[Id], [t].[Data]</span><br><span class="line">      FROM [TestTable01s] AS [t]</span><br><span class="line">      WHERE [t].[Id] = @__id_0</span><br></pre></td></tr></table></figure><p>仔细看两个控制台打印的sql语句，可以发现IQueryable的sql语句中多了where子句，并且where子句的参数是 @__id_0</p><table><thead><tr><th>方法</th><th>生成 SQL</th><th>参数</th><th>行数</th><th>评估位置</th></tr></thead><tbody><tr><td>IEnumerable 分支</td><td>SELECT … FROM TestTable01s 无 WHERE</td><td>无参数</td><td>全表</td><td>客户端（内存过滤）</td></tr><tr><td>IQueryable 分支</td><td>SELECT … FROM TestTable01s WHERE Id &#x3D; @__id_0</td><td>有参数</td><td>0~1 行</td><td>服务端（数据库过滤）</td></tr></tbody></table><h3 id="IEnumerable-端-1"><a href="#IEnumerable-端-1" class="headerlink" title="IEnumerable 端"></a>IEnumerable 端</h3><blockquote><p>Parameters&#x3D;[] 并且 SQL 里完全没有 WHERE 子句 → EF 把整个表拉回内存，再由 Enumerable.Where 在内存里筛选。</p></blockquote><h3 id="IQueryable-端-1"><a href="#IQueryable-端-1" class="headerlink" title="IQueryable 端"></a>IQueryable 端</h3><blockquote><p>带参数 @__id_0 且 SQL 出现 WHERE [t].[Id] &#x3D; @__id_0 → 过滤逻辑被翻译成 SQL，只返回匹配行，网络 IO 最小。</p></blockquote><p>数据表截图：<br><img src="https://origin.picgo.net/2025/12/09/adsfsfdfes89b6d3a27236f737.png" alt="adsfsfdfes"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录使用工厂模式加策略模式解决有多个不同邮件内容的难管理的痛点</title>
      <link href="/2025/12/07/%E8%AE%B0%E5%BD%95%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E5%8A%A0%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%9C%89%E5%A4%9A%E4%B8%AA%E4%B8%8D%E5%90%8C%E9%82%AE%E4%BB%B6%E5%86%85%E5%AE%B9%E7%9A%84%E9%9A%BE%E7%AE%A1%E7%90%86%E7%9A%84%E7%97%9B%E7%82%B9/"/>
      <url>/2025/12/07/%E8%AE%B0%E5%BD%95%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E5%8A%A0%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E8%A7%A3%E5%86%B3%E6%9C%89%E5%A4%9A%E4%B8%AA%E4%B8%8D%E5%90%8C%E9%82%AE%E4%BB%B6%E5%86%85%E5%AE%B9%E7%9A%84%E9%9A%BE%E7%AE%A1%E7%90%86%E7%9A%84%E7%97%9B%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="记录使用工厂模式加策略模式解决有多个不同邮件内容的难管理的痛点"><a href="#记录使用工厂模式加策略模式解决有多个不同邮件内容的难管理的痛点" class="headerlink" title="记录使用工厂模式加策略模式解决有多个不同邮件内容的难管理的痛点"></a>记录使用工厂模式加策略模式解决有多个不同邮件内容的难管理的痛点</h1><p>那天我正在写一个发送邮件验证码的功能，但是我开始的时候一出手就是if else，这样来判断应该发送什么内容的邮件，<br>后来我发现这样写太难维护了，然后我又换成了switch case，这样来判断应该发送什么内容的邮件，但是我觉得写太普通了，<br>所以我又换成了工厂模式加策略模式，这样来判断应该发送什么内容的邮件，这样就很方便了，而且也很好维护。后面需要新增邮件内容的时候，<br>只需要新增一个策略类，然后在工厂类的字典里面添加新的映射就行。所以我感觉设计模式还是很重要的，让代码更容易维护。不然如果使用if else，<br>那就需要修改很多地方。</p><h2 id="项目文件"><a href="#项目文件" class="headerlink" title="项目文件"></a>项目文件</h2><blockquote><p>appsettings.json<br>IEmailStrategy.cs<br>IEmailStrategyFactory.cs<br>IMailSendService.cs<br>EmailStrategyFactory.cs<br>MailSendService.cs<br>CaptchaConfig.cs &#x2F;&#x2F; 验证码配置<br>MailSendServiceConfig.cs &#x2F;&#x2F; 邮件发送服务配置</p></blockquote><h2 id="appsettings-json"><a href="#appsettings-json" class="headerlink" title="appsettings.json"></a>appsettings.json</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;DefaultConnection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;MailSendServiceConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;smtp.qq.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Port&quot;</span><span class="punctuation">:</span> <span class="number">587</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EmailLocalAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;SessionConfigure&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ExpirationTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;CaptchaConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CaptchaExpirationTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="IEmailStrategy-cs"><a href="#IEmailStrategy-cs" class="headerlink" title="IEmailStrategy.cs"></a>IEmailStrategy.cs</h2><p>邮箱策略接口<br>后面如果需要新增邮件类型，只需要新增一个策略类，然后在工厂类的字典里面添加新的映射就行</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02.Interfaces</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEmailStrategy</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> Subject &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">BuildBody</span>(<span class="params"><span class="built_in">string</span> captchaSTR, <span class="built_in">string</span> effectiveTime</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="IEmailStrategyFactory-cs"><a href="#IEmailStrategyFactory-cs" class="headerlink" title="IEmailStrategyFactory.cs"></a>IEmailStrategyFactory.cs</h2><p>邮箱策略工厂接口</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02.Interfaces</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEmailStrategyFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IEmailStrategy <span class="title">GetEmailStrategy</span>(<span class="params"><span class="built_in">string</span> emailType</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="IMailSendService-cs"><a href="#IMailSendService-cs" class="headerlink" title="IMailSendService.cs"></a>IMailSendService.cs</h2><p>邮件发送服务接口</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02.Interfaces</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMailSendService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//emailType:AccountRegister,PasswordForget,FriendVerification该参数用于策略模式选择不同的邮件模板，2025-10-4</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">SendMailSendService</span>(<span class="params"><span class="built_in">string</span> SendToMailAdd, <span class="built_in">string</span> captchaSTR, <span class="built_in">string</span> emailType</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="EmailStrategyFactory-cs"><a href="#EmailStrategyFactory-cs" class="headerlink" title="EmailStrategyFactory.cs"></a>EmailStrategyFactory.cs</h2><p>邮箱策略工厂</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DaiBanShiWuList01x02.Interfaces;</span><br><span class="line"><span class="keyword">using</span> DaiBanShiWuList01x02.Services.EmailStrategys;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmailStrategyFactory</span>: <span class="title">IEmailStrategyFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, IEmailStrategy&gt; _emailStrategies;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EmailStrategyFactory</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 目前是字典映射，后面会改成通过配置文件添加，2025-10-10</span></span><br><span class="line">            <span class="comment">//后面可以在加新的邮件类型，即把待办事项列表通过邮件发送给用户,提醒用户有哪些待办事项，2025-11-28</span></span><br><span class="line">            <span class="comment">//这种情况策略模式的好处就体现出来了，只需要新增一个策略类，然后在这里注册即可2025-11-28</span></span><br><span class="line">            _emailStrategies = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, IEmailStrategy&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                [<span class="string">&quot;AccountRegister&quot;</span>] = <span class="keyword">new</span> AccountRegisterEmailStrategy(),</span><br><span class="line">                [<span class="string">&quot;PasswordForget&quot;</span>] = <span class="keyword">new</span> PasswordForgetEmailStrategy(),</span><br><span class="line">                [<span class="string">&quot;FriendVerification&quot;</span>] = <span class="keyword">new</span> FriendVerificationEmailStrategy(),</span><br><span class="line">                [<span class="string">&quot;AccountLogin&quot;</span>] = <span class="keyword">new</span> AccountLoginEmailStrategy(),<span class="comment">//2025-12-01，新增邮箱验证码登录</span></span><br><span class="line">                [<span class="string">&quot;ChangeAccountName&quot;</span>] = <span class="keyword">new</span> ChangeAccountNameEmailStrategy()<span class="comment">//2025-12-02,修改账号名称</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IEmailStrategy <span class="title">GetEmailStrategy</span>(<span class="params"><span class="built_in">string</span> emailType</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _emailStrategies.TryGetValue(emailType, <span class="keyword">out</span> <span class="keyword">var</span> strategy);</span><br><span class="line">            <span class="keyword">return</span> strategy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="MailSendService-cs"><a href="#MailSendService-cs" class="headerlink" title="MailSendService.cs"></a>MailSendService.cs</h2><p>邮件发送服务</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> DaiBanShiWuList01x02.Interfaces;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> System.Net.Mail;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MailSendService</span>: <span class="title">IMailSendService</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用策略模式处理不同类型的邮件,相关代码已转移到文件夹Services/EmailStrategys，2025-10-4</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IOptionsMonitor&lt;MailSendServiceConfig&gt; _mailSendServiceConfig;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IOptionsMonitor&lt;CaptchaConfig&gt; _captchaConfig;<span class="comment">//2025-12-02</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IEmailStrategyFactory _emailStrategyFactory;<span class="comment">//这里我改了，原来是用的IEmailStrategyFactory，现在直接用工厂，2025-11-28,又改为使用接口</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MailSendService</span>(<span class="params">IOptionsMonitor&lt;MailSendServiceConfig&gt; mailSendServiceConfig, IEmailStrategyFactory emailStrategyFactory, IOptionsMonitor&lt;CaptchaConfig&gt; captchaConfig</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _mailSendServiceConfig = mailSendServiceConfig;</span><br><span class="line">            _emailStrategyFactory = emailStrategyFactory;</span><br><span class="line">            _captchaConfig = captchaConfig;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMailSendService</span>(<span class="params"><span class="built_in">string</span> SendToMailAdd, <span class="built_in">string</span> captchaSTR, <span class="built_in">string</span> emailType</span>)<span class="comment">//向该邮箱（SendToMailAdd）发送验证码（captchaSTR）</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//目前已有类型(3个，注意为字符串)</span></span><br><span class="line">            <span class="comment">//&quot;AccountRegister&quot;</span></span><br><span class="line">            <span class="comment">//&quot;PasswordForget&quot;</span></span><br><span class="line">            <span class="comment">//&quot;FriendVerification&quot;</span></span><br><span class="line">            <span class="comment">//&quot;AccountLogin&quot;//2025-12-01，新增邮箱验证码登录</span></span><br><span class="line">            <span class="keyword">var</span> emailStrategy = _emailStrategyFactory.GetEmailStrategy(emailType);<span class="comment">//2025-10-4，策略待实现。new 已经实现2025-10-26</span></span><br><span class="line"></span><br><span class="line">            MailMessage mailMessage = <span class="keyword">new</span> MailMessage</span><br><span class="line">            &#123;</span><br><span class="line">                From = <span class="keyword">new</span> MailAddress(_mailSendServiceConfig.CurrentValue.EmailLocalAddress, <span class="string">&quot;ClipFlow&quot;</span>, System.Text.Encoding.UTF8),</span><br><span class="line">                To = &#123; <span class="keyword">new</span> MailAddress(SendToMailAdd) &#125;,</span><br><span class="line">                Bcc = &#123; <span class="keyword">new</span> MailAddress(SendToMailAdd) &#125;,</span><br><span class="line">                Subject = emailStrategy.Subject,</span><br><span class="line">                SubjectEncoding = System.Text.Encoding.UTF8,</span><br><span class="line">                IsBodyHtml = <span class="literal">true</span>,</span><br><span class="line">                Body = <span class="string">$@&quot;<span class="subst">&#123;emailStrategy.BuildBody(captchaSTR,_captchaConfig.CurrentValue.CaptchaExpirationTime)&#125;</span>&quot;</span>,</span><br><span class="line">                BodyEncoding = System.Text.Encoding.UTF8</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            SmtpClient smtpClient = <span class="keyword">new</span> SmtpClient(_mailSendServiceConfig.CurrentValue.Host, _mailSendServiceConfig.CurrentValue.Port);</span><br><span class="line">            smtpClient.EnableSsl = <span class="literal">true</span>;</span><br><span class="line">            smtpClient.Credentials = <span class="keyword">new</span> NetworkCredential(_mailSendServiceConfig.CurrentValue.EmailLocalAddress, _mailSendServiceConfig.CurrentValue.keyword);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                smtpClient.Send(mailMessage);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;邮件发送失败: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CaptchaConfig-cs"><a href="#CaptchaConfig-cs" class="headerlink" title="CaptchaConfig.cs"></a>CaptchaConfig.cs</h2><p>验证码配置</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CaptchaConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> CaptchaExpirationTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="MailSendServiceConfig-cs"><a href="#MailSendServiceConfig-cs" class="headerlink" title="MailSendServiceConfig.cs"></a>MailSendServiceConfig.cs</h2><p>邮件发送服务配置</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DaiBanShiWuList01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MailSendServiceConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Host &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Port &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EmailLocalAddress &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> keyword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>在控制器里面声明属性：</p><blockquote><p>private readonly IMailSendService _mailSendService;<br>然后在构造函数中注入：</p></blockquote><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IMailSendService mailSendService</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _mailSendService = mailSendService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在控制器方法中使用：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_mailSendService.SendMailSendService(userAccount.Email, loginCaptchaSTR, <span class="string">&quot;AccountLogin&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NETCore轻量文心一言API小后端留档</title>
      <link href="/2025/12/07/ASP-NETCore%E8%BD%BB%E9%87%8F%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80API%E5%B0%8F%E5%90%8E%E7%AB%AF%E7%95%99%E6%A1%A3/"/>
      <url>/2025/12/07/ASP-NETCore%E8%BD%BB%E9%87%8F%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80API%E5%B0%8F%E5%90%8E%E7%AB%AF%E7%95%99%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="文心一言API小后端（-Net-7）"><a href="#文心一言API小后端（-Net-7）" class="headerlink" title="文心一言API小后端（.Net 7）"></a>文心一言API小后端（.Net 7）</h1><p>我没有写什么详细的介绍，这是流水账记录，里面有很多代码是没有用的，但是我懒得删，就当是记录自己的问题吧。</p><blockquote><p>这是之前写过的一个ASP.NET Core的文心一言API，后面过了将近一年又拿出来修改了一下，部署在云服务上了，写这玩意的目的是为了Linux和一些考试去作弊用的，<br>因为我发现学校使用极域管理机房电脑，禁止浏览器访问页面是封的80标准端口，所以就写了个API，把它部署在非80端口上，<br>就绕过极域的封禁去使用ai,但考试改成笔试了。</p></blockquote><h2 id="项目文件"><a href="#项目文件" class="headerlink" title="项目文件"></a>项目文件</h2><blockquote><p> AiChatController.cs<br> appsettings.json<br> Program.cs<br> UserSessionManager.cs<br> WxyyAiModelConfig.cs<br> WxyyAiModels.cs</p></blockquote><h2 id="appsettings-json"><a href="#appsettings-json" class="headerlink" title="appsettings.json"></a>appsettings.json</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;WxyyAiModelConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;API_KEY02&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;KEY&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;SECRET_KEY02&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;KEY&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ModelContextSize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20&quot;</span><span class="comment">//这个是模型上下文大小，默认20，可以根据需要调整，但是太大会导致性能问题，太小会导致模型不准确</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="WxyyAiModelConfig-cs"><a href="#WxyyAiModelConfig-cs" class="headerlink" title="WxyyAiModelConfig.cs"></a>WxyyAiModelConfig.cs</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">AiChatAPI01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WxyyAiModelConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> API_KEY02 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> SECRET_KEY02 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ModelContextSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Program-cs"><a href="#Program-cs" class="headerlink" title="Program.cs"></a>Program.cs</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> AiChatAPI01x02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add services to the container.</span></span><br><span class="line"></span><br><span class="line">builder.Services.AddControllers();</span><br><span class="line"><span class="comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span></span><br><span class="line">builder.Services.AddEndpointsApiExplorer();</span><br><span class="line">builder.Services.AddSwaggerGen();</span><br><span class="line">builder.Services.AddOptions&lt;WxyyAiModelConfig&gt;();</span><br><span class="line">builder.Services.Configure&lt;WxyyAiModelConfig&gt;(builder.Configuration.GetSection(<span class="string">&quot;WxyyAiModelConfig&quot;</span>));</span><br><span class="line">builder.Services.AddSingleton&lt;UserSessionManager&gt;();</span><br><span class="line">builder.Services.AddCors(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.AddPolicy(<span class="string">&quot;AllowAll&quot;</span>, policy =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        policy.AllowAnyOrigin()</span><br><span class="line">              .AllowAnyMethod()</span><br><span class="line">              .AllowAnyHeader();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure the HTTP request pipeline.</span></span><br><span class="line"><span class="comment">//if (app.Environment.IsDevelopment())//注释掉这行，是为了在部署后的非开发环境，也能使用swagger的ui访问</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line">    app.UseSwagger();</span><br><span class="line">    app.UseSwaggerUI();</span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">app.UseHttpsRedirection();</span><br><span class="line"></span><br><span class="line">app.UseCors(<span class="string">&quot;AllowAll&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">app.MapControllers();</span><br><span class="line"></span><br><span class="line">app.Run();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="WxyyAiModels-cs"><a href="#WxyyAiModels-cs" class="headerlink" title="WxyyAiModels.cs"></a>WxyyAiModels.cs</h2><p>如果不需要使用上下文保持，可以直接调用 Task<string> DiaoYongAiModelAsync(string question)方法，传入问题，返回回答。<br>如果需要使用上下文保持，调用Task<string> DiaoYongAiModelAsync(string userId, List<ChatVO> messages)<br>这个userId是GenerateUserId()方法生成的，可以自己实现，但是要保证唯一性，可以使用Guid.NewGuid().ToString()</p><p>关于为什么这么多的方法中都有测试未通过。是因为在最初文心一言的API调用后，返回的数据中有一些id之类的，这些id在每次调用后还不一样，<br>然后我就以为这个api就已经实现了上下文，但我用的时候没有上下文，是因为没有用它返回的那个id，所以就一直没有上下文。<br>所以我就去官方文档里面查，就根本没发现这个id的作用，然后我就想，这有没有可能就是只是一个普通的uuid或者guid用来标识这次对话的。<br>然后我再文档里面看到要是实现上下文保持，需要我们在后端自己去实现，简单的方法就是直接使用一个列表作为上下文，然后每次调用的时候，<br>把这个列表的数据传给api,api返回的结果又加入列表，用户的输入也加入列表，循环往复就这样。就可以实现上下文保持了。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AiChatAPI01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">WxyyAiModels</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> API_KEY02;</span><br><span class="line">        <span class="built_in">string</span> SECRET_KEY02;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> HttpClient _httpClient;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WxyyAiModels</span>(<span class="params"><span class="built_in">string</span> aPI_KEY02, <span class="built_in">string</span> sECRET_KEY02</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _httpClient = <span class="keyword">new</span> HttpClient();</span><br><span class="line">            API_KEY02 = aPI_KEY02;</span><br><span class="line">            SECRET_KEY02 = sECRET_KEY02;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//只需要在外面调用这个方法即可。即调即用，2024-9-12，但是没有上下文保持2025-11-7</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">DiaoYongAiModelAsync</span>(<span class="params"><span class="built_in">string</span> question</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">await</span> GetAccessTokenAsync();</span><br><span class="line">            List&lt;ChatVO&gt; messages = <span class="keyword">new</span> List&lt;ChatVO&gt;();</span><br><span class="line">            ChatVO chat01 = <span class="keyword">new</span> ChatVO</span><br><span class="line">            &#123;</span><br><span class="line">                role = <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                content = <span class="string">$&quot;<span class="subst">&#123;question&#125;</span>&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            messages.Add(chat01);</span><br><span class="line">            <span class="keyword">var</span> chatMsg = <span class="keyword">await</span> GetChatAsync(token, <span class="string">&quot;13900000011&quot;</span>, messages);</span><br><span class="line">            <span class="keyword">return</span> chatMsg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//新的方法，提供上下文保持，通过userId来进行上下文保持。2025-11-7,测试未通过</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">DiaoYongAiModelAsync</span>(<span class="params"><span class="built_in">string</span> userId,<span class="built_in">string</span> question</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">await</span> GetAccessTokenAsync();</span><br><span class="line">            List&lt;ChatVO&gt; messages = <span class="keyword">new</span> List&lt;ChatVO&gt;();</span><br><span class="line">            ChatVO chat01 = <span class="keyword">new</span> ChatVO</span><br><span class="line">            &#123;</span><br><span class="line">                role = <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                content = <span class="string">$&quot;<span class="subst">&#123;question&#125;</span>&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            messages.Add(chat01);</span><br><span class="line">            <span class="keyword">var</span> chatMsg = <span class="keyword">await</span> GetChatAsync(token, userId, messages);</span><br><span class="line">            <span class="keyword">return</span> chatMsg;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//新的方法，传入整个ChatList，进行上下文保持。2025-11-8（通过测试）</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">DiaoYongAiModelAsync</span>(<span class="params"><span class="built_in">string</span> userId, List&lt;ChatVO&gt; messages</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">await</span> GetAccessTokenAsync();</span><br><span class="line">            <span class="keyword">var</span> chatMsg = <span class="keyword">await</span> GetChatAsync(token, <span class="string">&quot;123453323&quot;</span>, messages);</span><br><span class="line">            <span class="keyword">return</span> chatMsg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//新方法，ai翻译，不需要上下文保持。2025-11-11</span></span><br><span class="line">        <span class="comment">//question:需要翻译的内容,from:需要翻译的语言,to:翻译成的语言</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">DiaoYongAiTranslationAsync</span>(<span class="params"><span class="built_in">string</span> question, <span class="built_in">string</span> <span class="keyword">from</span>, <span class="built_in">string</span> to</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">await</span> GetAccessTokenAsync();</span><br><span class="line">            List&lt;ChatVO&gt; messages = <span class="keyword">new</span> List&lt;ChatVO&gt;();</span><br><span class="line">            ChatVO chat01 = <span class="keyword">new</span> ChatVO</span><br><span class="line">            &#123;</span><br><span class="line">                role = <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                content = <span class="string">$&quot;你是一个ai翻译助手的api，把-<span class="subst">&#123;question&#125;</span>-,从-<span class="subst">&#123;<span class="keyword">from</span>&#125;</span>-翻译成-<span class="subst">&#123;to&#125;</span>-，注意仅返回翻译后的内容。因为我的后端系统只能处理翻译后的内容,否则会报错。&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            messages.Add(chat01);</span><br><span class="line">            <span class="keyword">var</span> chatMsg = <span class="keyword">await</span> GetChatAsync(token, <span class="string">&quot;123453323&quot;</span>, messages);</span><br><span class="line">            <span class="keyword">return</span> chatMsg;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//新方法，ai答题，不需要上下文保持。2025-11-11</span></span><br><span class="line">        <span class="comment">//question:需要答题的内容</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">DiaoYongAiAnswerAsync</span>(<span class="params"><span class="built_in">string</span> question</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">await</span> GetAccessTokenAsync();</span><br><span class="line">            List&lt;ChatVO&gt; messages = <span class="keyword">new</span> List&lt;ChatVO&gt;();</span><br><span class="line">            ChatVO chat01 = <span class="keyword">new</span> ChatVO</span><br><span class="line">            &#123;</span><br><span class="line">                role = <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                content = <span class="string">$&quot;你是一个ai答题助手的api，把-<span class="subst">&#123;question&#125;</span>-,答题，注意仅返回答案，不要返回题目。因为我的后端系统只能处理答案,否则会报错。&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            messages.Add(chat01);</span><br><span class="line">            <span class="keyword">var</span> chatMsg = <span class="keyword">await</span> GetChatAsync(token, <span class="string">&quot;123453323&quot;</span>, messages);</span><br><span class="line">            <span class="keyword">return</span> chatMsg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用token加userId,进行聊天，测试未通过2025-11-7，我查了官方的文档，token本身不支持上下文保持</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">DiaoYongAiModelAsync</span>(<span class="params"><span class="built_in">string</span> token,<span class="built_in">string</span> userId, <span class="built_in">string</span> question</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;ChatVO&gt; messages = <span class="keyword">new</span> List&lt;ChatVO&gt;();</span><br><span class="line">            ChatVO chat01 = <span class="keyword">new</span> ChatVO</span><br><span class="line">            &#123;</span><br><span class="line">                role = <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                content = <span class="string">$&quot;<span class="subst">&#123;question&#125;</span>&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            messages.Add(chat01);</span><br><span class="line">            <span class="keyword">var</span> chatMsg = <span class="keyword">await</span> GetChatAsync(token, userId, messages);</span><br><span class="line">            <span class="keyword">return</span> chatMsg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">GetChatAsync</span>(<span class="params"><span class="built_in">string</span> accessToken, <span class="built_in">string</span> userId, List&lt;ChatVO&gt; messages</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            WxyyChatReq wxyyChatReq = <span class="keyword">new</span> WxyyChatReq</span><br><span class="line">            &#123;</span><br><span class="line">                user_id = userId,</span><br><span class="line">                messages = messages,</span><br><span class="line">                temperature = <span class="number">0.95</span>,</span><br><span class="line">                top_p = <span class="number">0.8</span>,</span><br><span class="line">                penalty_score = <span class="number">1</span>,</span><br><span class="line">                disable_search = <span class="literal">false</span>,</span><br><span class="line">                enable_citation = <span class="literal">false</span>,</span><br><span class="line">                stream = <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> url = <span class="string">$&quot;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions_pro?access_token=<span class="subst">&#123;accessToken&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> json = JsonConvert.SerializeObject(wxyyChatReq);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> response = <span class="keyword">await</span> _httpClient.PostAsync(url, <span class="keyword">new</span> StringContent(json, System.Text.Encoding.UTF8, <span class="string">&quot;application/json&quot;</span>));</span><br><span class="line">            <span class="keyword">var</span> content = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> content;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取token</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">GetAccessTokenAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> url = <span class="string">&quot;https://aip.baidubce.com/oauth/2.0/token&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> content = <span class="keyword">new</span> FormUrlEncodedContent(<span class="keyword">new</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;(<span class="string">&quot;grant_type&quot;</span>, <span class="string">&quot;client_credentials&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;(<span class="string">&quot;client_id&quot;</span>, API_KEY02),</span><br><span class="line">                <span class="keyword">new</span> KeyValuePair&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;(<span class="string">&quot;client_secret&quot;</span>, SECRET_KEY02)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> response = <span class="keyword">await</span> _httpClient.PostAsync(url, content);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br><span class="line">            <span class="keyword">var</span> json = JsonConvert.DeserializeObject&lt;<span class="built_in">dynamic</span>&gt;(result);</span><br><span class="line">            <span class="keyword">return</span> json.access_token.ToString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WxyyChatReq</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> user_id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> temperature &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> top_p &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> penalty_score &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> disable_search &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> enable_citation &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> stream &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List&lt;ChatVO&gt; messages &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChatVO</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> role &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="UserSessionManager-cs"><a href="#UserSessionManager-cs" class="headerlink" title="UserSessionManager.cs"></a>UserSessionManager.cs</h2><p>通过userId管理多个用户的上下文.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">AiChatAPI01x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserSessionManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//用户通过api把消息发送到后端，后端接收，然后把消息存入用户上下文列表中，然后把整个上下文列表即List&lt;ChatVO&gt;传给ai模型</span></span><br><span class="line">        <span class="comment">//这样可以实现了一个简单的上下文记忆。2025-11-8</span></span><br><span class="line">        <span class="comment">//生成用户id</span></span><br><span class="line">        <span class="comment">//删除用户id</span></span><br><span class="line">        <span class="comment">//添加用户会话</span></span><br><span class="line">        <span class="comment">//删除用户会话</span></span><br><span class="line">        <span class="comment">//获取用户会话</span></span><br><span class="line">        <span class="comment">//更新用户会话</span></span><br><span class="line">        <span class="comment">//使用流程：先生成用户id，然后添加用户会话，然后更新用户会话。</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ChatVO&gt;&gt; _userSessions = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, List&lt;ChatVO&gt;&gt;();</span><br><span class="line">        <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; _userIds = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserSessionManager</span>()</span> &#123; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GenerateUserId</span>(<span class="params"><span class="built_in">int</span> longth</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> userId = Guid.NewGuid().ToString(<span class="string">&quot;N&quot;</span>).Substring(<span class="number">0</span>, longth);</span><br><span class="line">            _userIds.Add(userId);</span><br><span class="line">            <span class="keyword">return</span> userId;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteUserId</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _userIds.Remove(userId);</span><br><span class="line">            <span class="keyword">return</span> _userSessions.Remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; <span class="title">GetAllUserIds</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> _userIds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddUserSession</span>(<span class="params"><span class="built_in">string</span> userId, List&lt;ChatVO&gt; chatVOs</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _userSessions.Add(userId, chatVOs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteUserSession</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> _userSessions.Remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//把用户输入的message添加到List&lt;ChatVO&gt;2025-11-8</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateUserSessionAboutAddTheNewMessage_UserInput</span>(<span class="params"><span class="built_in">string</span> userId, <span class="built_in">string</span> message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_userSessions.ContainsKey(userId))</span><br><span class="line">            &#123;</span><br><span class="line">                ChatVO chatVO = <span class="keyword">new</span> ChatVO</span><br><span class="line">                &#123;</span><br><span class="line">                    role = <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                    content = message</span><br><span class="line">                &#125;;</span><br><span class="line">                _userSessions[userId].Add(chatVO);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//把ai返回的message添加到List&lt;ChatVO&gt;2025-11-8</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateUserSessionAboutAddTheNewMessage_AiResponse</span>(<span class="params"><span class="built_in">string</span> userId, <span class="built_in">string</span> message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_userSessions.ContainsKey(userId))</span><br><span class="line">            &#123;</span><br><span class="line">                ChatVO chatVO = <span class="keyword">new</span> ChatVO</span><br><span class="line">                &#123;</span><br><span class="line">                    role = <span class="string">&quot;assistant&quot;</span>,</span><br><span class="line">                    content = message</span><br><span class="line">                &#125;;</span><br><span class="line">                _userSessions[userId].Add(chatVO);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查用户对话的轮数，超过一定数量则删除最早的对话2025-11-8</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckAndTrimUserSession</span>(<span class="params"><span class="built_in">string</span> userId, <span class="built_in">int</span> maxRounds</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_userSessions.ContainsKey(userId))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> sessions = _userSessions[userId];</span><br><span class="line">                <span class="built_in">int</span> rounds = sessions.Count / <span class="number">2</span>; </span><br><span class="line">                <span class="keyword">if</span> (rounds &gt; maxRounds)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> messagesToRemove = (rounds - maxRounds) * <span class="number">2</span>; </span><br><span class="line">                    sessions.RemoveRange(<span class="number">0</span>, messagesToRemove);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取用户对话的上下文</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;ChatVO&gt; <span class="title">GetUserSession</span>(<span class="params"><span class="built_in">string</span> userId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_userSessions.ContainsKey(userId))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _userSessions[userId];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//删除所以的用户会话</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ClearAllUserSessions</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _userSessions.Clear();</span><br><span class="line">            _userIds.Clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="AiChatController-cs"><a href="#AiChatController-cs" class="headerlink" title="AiChatController.cs"></a>AiChatController.cs</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AiChatAPI01x02.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]/[action]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AiChatController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IOptionsMonitor&lt;WxyyAiModelConfig&gt; _wxyyAiModelConfig;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> UserSessionManager _userSessionManager;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AiChatController</span>(<span class="params">IOptionsMonitor&lt;WxyyAiModelConfig&gt; wxyyAiModelConfig, UserSessionManager userSessionManager</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _wxyyAiModelConfig = wxyyAiModelConfig;</span><br><span class="line">            _userSessionManager = userSessionManager;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//无法记起上下文的原因找到了，这个api本身不提供会话保持，同时我在官方文档中也没有找到</span></span><br><span class="line">        <span class="comment">//看来需要我在后端自己写，2025-11-7</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//解决方法就是把之前每次的会话都保存起来（保持在内存中吧，这样比较快），然后每次调用的时候把之前的会话传进去。</span></span><br><span class="line">        <span class="comment">//但需要注意的是，存的大小，允许存几轮对话，太大了会导致内存溢出。2025-11-7</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//客户端调用api,输入userid和message,后端拿到message后，把他存入对应的userid的会话列表中，然后把整个会话列表传给ai模型。</span></span><br><span class="line">        <span class="comment">//这个userid的会话列表是在内存中的，不会保存在数据库中。（看具体情况而定）2025-11-7</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//需要注意内存伪共享问题，原来还有这种问题，2025-11-8</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//旧的方法，不提供会话保持</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; ChatToAi01([FromBody] <span class="built_in">string</span> message)</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="built_in">string</span> result = <span class="keyword">await</span> <span class="keyword">new</span> WxyyAiModels(_wxyyAiModelConfig.CurrentValue.API_KEY02, _wxyyAiModelConfig.CurrentValue.SECRET_KEY02).DiaoYongAiModelAsync(message);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;新方法02&gt;</span></span></span><br><span class="line">        <span class="comment">//新的方法，提供会话保持，通过List&lt;ChatVO&gt;来进行会话保持。2025-11-8</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; GenerateUserId()</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="built_in">string</span> userId = _userSessionManager.GenerateUserId(<span class="number">4</span>);</span><br><span class="line">            _userSessionManager.AddUserSession(userId, <span class="keyword">new</span> List&lt;ChatVO&gt;());</span><br><span class="line">            <span class="keyword">return</span> userId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//删除UserId</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; DeleteUserId([FromForm] <span class="built_in">string</span> userId)</span><br><span class="line">        &#123; </span><br><span class="line">            _userSessionManager.DeleteUserId(userId);</span><br><span class="line">            <span class="keyword">if</span> (_userSessionManager.GetAllUserIds().Contains(userId))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;删除失败&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;删除成功&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取所有UserId</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;List&lt;<span class="built_in">string</span>&gt;&gt;&gt; GetAllUserIds()</span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">return</span> _userSessionManager.GetAllUserIds();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//删除所有UserSession</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; ClearAllUserSession()</span><br><span class="line">        &#123; </span><br><span class="line">            _userSessionManager.ClearAllUserSessions();</span><br><span class="line">            <span class="keyword">if</span> (_userSessionManager.GetAllUserIds().Count != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;删除失败&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;删除成功&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//聊天,还需要在WxxyAiModels中为该方法适配一个方法，2025-11-8</span></span><br><span class="line">        <span class="comment">//在_userSessionManager中获取指定userId的完整List&lt;ChatVO&gt;</span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; ChatToAi02([FromForm] <span class="built_in">string</span> userId, [FromBody]<span class="built_in">string</span> message)</span><br><span class="line">        &#123;</span><br><span class="line">            _userSessionManager.CheckAndTrimUserSession(userId,<span class="built_in">int</span>.Parse(_wxyyAiModelConfig.CurrentValue.ModelContextSize));<span class="comment">//检查并修剪,防止内存溢出,设置最大会话数，2025-11-8</span></span><br><span class="line">            _userSessionManager.UpdateUserSessionAboutAddTheNewMessage_UserInput(userId, message);</span><br><span class="line">            <span class="keyword">var</span> userInput = _userSessionManager.GetUserSession(userId);</span><br><span class="line">            <span class="built_in">string</span> result = <span class="keyword">await</span> <span class="keyword">new</span> WxyyAiModels(_wxyyAiModelConfig.CurrentValue.API_KEY02, _wxyyAiModelConfig.CurrentValue.SECRET_KEY02).DiaoYongAiModelAsync(userId, userInput);</span><br><span class="line">            _userSessionManager.UpdateUserSessionAboutAddTheNewMessage_AiResponse(userId, result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;/新方法02&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;ai翻译&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; AiTranslation([FromForm] <span class="built_in">string</span> message, <span class="built_in">string</span> <span class="keyword">from</span>, <span class="built_in">string</span> to)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> result = <span class="keyword">await</span> <span class="keyword">new</span> WxyyAiModels(_wxyyAiModelConfig.CurrentValue.API_KEY02, _wxyyAiModelConfig.CurrentValue.SECRET_KEY02).DiaoYongAiTranslationAsync(message, <span class="keyword">from</span>, to);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;/ai翻译&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;ai答题助手&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; AiAnswerQuestion([FromForm] <span class="built_in">string</span> question)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> result = <span class="keyword">await</span> <span class="keyword">new</span> WxyyAiModels(_wxyyAiModelConfig.CurrentValue.API_KEY02, _wxyyAiModelConfig.CurrentValue.SECRET_KEY02).DiaoYongAiAnswerAsync(question);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;/ai答题助手&gt;</span></span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在AspNetCore中设计通用仓储接口</title>
      <link href="/2025/09/25/%E5%9C%A8AspNetCore%E4%B8%AD%E8%AE%BE%E8%AE%A1%E9%80%9A%E7%94%A8%E4%BB%93%E5%82%A8%E6%8E%A5%E5%8F%A3/"/>
      <url>/2025/09/25/%E5%9C%A8AspNetCore%E4%B8%AD%E8%AE%BE%E8%AE%A1%E9%80%9A%E7%94%A8%E4%BB%93%E5%82%A8%E6%8E%A5%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="在AspNetCore中设计通用仓储接口"><a href="#在AspNetCore中设计通用仓储接口" class="headerlink" title="在AspNetCore中设计通用仓储接口"></a>在AspNetCore中设计通用仓储接口</h1><p>对于一个项目来说，数据库的增删改查操作是必不可少的，而对于一个项目来说，数据库的增删改查操作是必不可少的,<br>所以一个合理的仓储接口设计是必不可少的。这里我使用的ORM框架是EF Core，所以我这里的仓储接口设计是基于EF Core的。    </p><h3 id="需要安装的包"><a href="#需要安装的包" class="headerlink" title="需要安装的包"></a>需要安装的包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.EntityFrameworkCore</span><br><span class="line">Microsoft.EntityFrameworkCore.SqlServer</span><br><span class="line">Microsoft.EntityFrameworkCore.Tools</span><br></pre></td></tr></table></figure><h3 id="配置数据库连接字符串——参考之前的文章AspNetCore读取配置文件的方案四"><a href="#配置数据库连接字符串——参考之前的文章AspNetCore读取配置文件的方案四" class="headerlink" title="配置数据库连接字符串——参考之前的文章AspNetCore读取配置文件的方案四"></a>配置数据库连接字符串——参考之前的文章AspNetCore读取配置文件的方案四</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Logging&quot;: &#123;</span><br><span class="line">    &quot;LogLevel&quot;: &#123;</span><br><span class="line">      &quot;Default&quot;: &quot;Information&quot;,</span><br><span class="line">      &quot;Microsoft.AspNetCore&quot;: &quot;Warning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;SqlServerConfig&quot;: &#123;</span><br><span class="line">    &quot;ConnectionString&quot;: &quot;Server = (localdb)\\mssqllocaldb;DataBase = APIEFcTYCCJK02x02Db01;Trusted_Connection = true;TrustServerCertificate = true;&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;AllowedHosts&quot;: &quot;*&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="为其创建配置类"><a href="#为其创建配置类" class="headerlink" title="为其创建配置类"></a>为其创建配置类</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SqlServerConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ConnectionString &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="在Program-cs中添加配置，这里需要注意的是，这里的配置类需要在服务容器中注册，否则无法使用IOptionsMonitor"><a href="#在Program-cs中添加配置，这里需要注意的是，这里的配置类需要在服务容器中注册，否则无法使用IOptionsMonitor" class="headerlink" title="在Program.cs中添加配置，这里需要注意的是，这里的配置类需要在服务容器中注册，否则无法使用IOptionsMonitor"></a>在Program.cs中添加配置，这里需要注意的是，这里的配置类需要在服务容器中注册，否则无法使用IOptionsMonitor</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddOptions&lt;SqlServerConfig&gt;();</span><br><span class="line">builder.Services.Configure&lt;SqlServerConfig&gt;(builder.Configuration.GetSection(<span class="string">&quot;SqlServerConfig&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="创建实体模型类"><a href="#创建实体模型类" class="headerlink" title="创建实体模型类"></a>创建实体模型类</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations.Schema;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestDataTable01</span></span><br><span class="line">    &#123;        </span><br><span class="line">        [<span class="meta">Key</span>]<span class="comment">//主键</span></span><br><span class="line">        [<span class="meta">DatabaseGenerated(DatabaseGeneratedOption.None)</span>]<span class="comment">//自定义主键</span></span><br><span class="line">        [<span class="meta">MaxLength(50)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Description &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建数据库上下文类"><a href="#创建数据库上下文类" class="headerlink" title="创建数据库上下文类"></a>创建数据库上下文类</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataContext</span>:<span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataContext</span>(<span class="params">DbContextOptions&lt;DataContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span> &#123; &#125;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;TestDataTable01&gt; TestDataTable01s &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在Program-cs中添加服务，这里需要注意的是，这里的数据库上下文类需要在服务容器中注册，否则无法使用IOptionsMonitor"><a href="#在Program-cs中添加服务，这里需要注意的是，这里的数据库上下文类需要在服务容器中注册，否则无法使用IOptionsMonitor" class="headerlink" title="在Program.cs中添加服务，这里需要注意的是，这里的数据库上下文类需要在服务容器中注册，否则无法使用IOptionsMonitor"></a>在Program.cs中添加服务，这里需要注意的是，这里的数据库上下文类需要在服务容器中注册，否则无法使用IOptionsMonitor</h3><p>这里需从服务容器中获取IOptionsMonitor，所以这一步必须在数据库字符串配置类的注册之后，否则会报错。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddDbContext&lt;DataContext&gt;((serviceProvider, options) =&gt;</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">var</span> sqlServerConfig = serviceProvider.GetRequiredService&lt;IOptionsMonitor&lt;SqlServerConfig&gt;&gt;().CurrentValue;</span><br><span class="line">    options.UseSqlServer(sqlServerConfig.ConnectionString);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="创建通用仓储接口IRepositoryBase"><a href="#创建通用仓储接口IRepositoryBase" class="headerlink" title="创建通用仓储接口IRepositoryBase"></a>创建通用仓储接口IRepositoryBase<T></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRepositoryBase</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Task&lt;IEnumerable&lt;T&gt;&gt; GetAllAsync();<span class="comment">//这个方法其实我不想写</span></span><br><span class="line">        <span class="function">Task&lt;T&gt; <span class="title">GetByIdAsync</span>(<span class="params"><span class="built_in">string</span> id</span>)</span>;</span><br><span class="line">        <span class="function">Task <span class="title">AddAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function">Task <span class="title">UpdateByIdAsync</span>(<span class="params"><span class="built_in">string</span> id, T entity</span>)</span>;</span><br><span class="line">        <span class="function">Task <span class="title">DeleteByIdAsync</span>(<span class="params"><span class="built_in">string</span> id</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">IsEmptyAsync</span>(<span class="params"><span class="built_in">string</span> id</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">SaveChangesAsync</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建仓储实现类RepositoryBase"><a href="#创建仓储实现类RepositoryBase" class="headerlink" title="创建仓储实现类RepositoryBase"></a>创建仓储实现类RepositoryBase<T></h3><p>这里的泛型T是实体模型类，所以需要在构造函数中注入数据库上下文类DataContext，注意是DataContext，不是DbContext，<br>因为DbContext是抽象类，DataContext是派生类，所以需要注入DataContext，而不是DbContext。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RepositoryBase</span>&lt;<span class="title">T</span>&gt;: <span class="title">IRepositoryBase</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> DataContext _context;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RepositoryBase</span>(<span class="params">DataContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _context = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">AddAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> _context.Set&lt;T&gt;().AddAsync(entity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IEnumerable</span>&lt;<span class="title">T</span>&gt;&gt; <span class="title">GetAllAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> _context.Set&lt;T&gt;().ToListAsync();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">T</span>&gt; <span class="title">GetByIdAsync</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> _context.Set&lt;T&gt;().FindAsync(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">SaveChangesAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">await</span> _context.SaveChangesAsync() &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">UpdateByIdAsync</span>(<span class="params"><span class="built_in">string</span> id, T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">var</span> entityUpdate = <span class="keyword">await</span> _context.Set&lt;T&gt;().FindAsync(id);</span><br><span class="line">            <span class="keyword">if</span> (entityUpdate != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _context.Entry(entityUpdate).CurrentValues.SetValues(entity);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteByIdAsync</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> entity = <span class="keyword">await</span> _context.Set&lt;T&gt;().FindAsync(id);</span><br><span class="line">            <span class="keyword">if</span> (entity != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _context.Set&lt;T&gt;().Remove(entity);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">IsEmptyAsync</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> entity = <span class="keyword">await</span> _context.Set&lt;T&gt;().FindAsync(id);</span><br><span class="line">            <span class="keyword">if</span> (entity == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在Program-cs中添加仓储实现类"><a href="#在Program-cs中添加仓储实现类" class="headerlink" title="在Program.cs中添加仓储实现类"></a>在Program.cs中添加仓储实现类</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddScoped(<span class="keyword">typeof</span>(IRepositoryBase&lt;&gt;), <span class="keyword">typeof</span>(RepositoryBase&lt;&gt;));</span><br></pre></td></tr></table></figure><h3 id="再为TestDataTable01创建一个具体的，不通用的仓储实现类，来解决一些特殊的，通用仓储接口无法实现的需求"><a href="#再为TestDataTable01创建一个具体的，不通用的仓储实现类，来解决一些特殊的，通用仓储接口无法实现的需求" class="headerlink" title="再为TestDataTable01创建一个具体的，不通用的仓储实现类，来解决一些特殊的，通用仓储接口无法实现的需求"></a>再为TestDataTable01创建一个具体的，不通用的仓储实现类，来解决一些特殊的，通用仓储接口无法实现的需求</h3><p>如对其密码的验证，密码修改等，这种需求可以通过继承通用仓储实现类来解决。先创建具体的仓储接口，然后再创建具体的仓储实现类，<br>然后在具体的仓储实现类中实现具体的需求。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITestDataTableRepository</span>:<span class="title">IRepositoryBase</span>&lt;<span class="title">TestDataTable01</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">VerifyPasswordAsync</span>(<span class="params"><span class="built_in">string</span> id, <span class="built_in">string</span> password</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">ChangePasswordAsync</span>(<span class="params"><span class="built_in">string</span> id, <span class="built_in">string</span> oldPassword, <span class="built_in">string</span> newPassword</span>)</span>;</span><br><span class="line">        <span class="comment">//使用MD5加密,不可逆,加密不属于通用需求，所以不放在IRepositoryBase，应该单独注册一个服务而不是接口，然后在VerifyPasswordAsync中调用</span></span><br><span class="line">        <span class="comment">//在VerifyPasswordAsync中直接对比加密后的密码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注意在具体的仓储实现类中，需要注入数据库上下文类DataContext，因为需要使用到数据库上下文类DataContext，</li><li>注意是DataContext，不是DbContext，</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> APIEFcTYCCJK02x02;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestDataTableRepository</span>: <span class="title">RepositoryBase</span>&lt;<span class="title">TestDataTable01</span>&gt;,<span class="title">ITestDataTableRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> DataContext _context &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestDataTableRepository</span>(<span class="params">DataContext context</span>):<span class="title">base</span>(<span class="params">context</span>)</span> &#123; _context = context; &#125;</span><br><span class="line">        <span class="comment">//使用MD5加密,不可逆,加密不属于通用需求，所以不放在IRepositoryBase，应该单独注册一个服务而不是接口，然后在VerifyPasswordAsync中调用</span></span><br><span class="line">        <span class="comment">//在VerifyPasswordAsync中直接对比加密后的密码2025.9.24</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">VerifyPasswordAsync</span>(<span class="params"><span class="built_in">string</span> id, <span class="built_in">string</span> password</span>)</span> </span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">var</span> entity = <span class="keyword">await</span> _context.Set&lt;TestDataTable01&gt;().FindAsync(id);</span><br><span class="line">        <span class="keyword">if</span> (entity == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entity.Password == password;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">ChangePasswordAsync</span>(<span class="params"><span class="built_in">string</span> id, <span class="built_in">string</span> oldPassword, <span class="built_in">string</span> newPassword</span>)</span> </span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">var</span> entity = <span class="keyword">await</span> _context.Set&lt;TestDataTable01&gt;().FindAsync(id);</span><br><span class="line">        <span class="keyword">if</span> (entity == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (entity.Password != oldPassword)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        entity.Password = newPassword;</span><br><span class="line">        <span class="keyword">await</span> _context.SaveChangesAsync();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="这个具体的仓储接口同样需要在Program-cs中注册"><a href="#这个具体的仓储接口同样需要在Program-cs中注册" class="headerlink" title="这个具体的仓储接口同样需要在Program.cs中注册"></a>这个具体的仓储接口同样需要在Program.cs中注册</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddScoped&lt;ITestDataTableRepository, TestDataTableRepository&gt;();</span><br></pre></td></tr></table></figure><h3 id="在控制器中使用"><a href="#在控制器中使用" class="headerlink" title="在控制器中使用"></a>在控制器中使用</h3><p>通用仓储接口IRepositoryBase<T>，具体的仓储接口ITestDataTableRepository，都是在Program.cs中注册的，<br>所以在控制器中可以直接注入，不需要再在控制器中注入具体的仓储实现类，因为具体的仓储实现类已经在Program.cs中注册了。</p><p>注意：</p><ul><li>一次传多个参数使用[FromForm]，一次传一个参数使用[FromBody]。</li><li>IActionResult不包含返回值的类型信息，所以这里使用ActionResult。</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">APIEFcTYCCJK02x02.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;[controller]/[action]&quot;</span>)</span>]<span class="comment">//RPC风格的路由</span></span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RepositoryBaseTestController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRepositoryBase&lt;TestDataTable01&gt; _repositoryBase;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> ITestDataTableRepository _testDataTableRepository;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RepositoryBaseTestController</span>(<span class="params">IRepositoryBase&lt;TestDataTable01&gt; repositoryBase, ITestDataTableRepository testDataTableRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _repositoryBase = repositoryBase;</span><br><span class="line">            _testDataTableRepository = testDataTableRepository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;TestDataTable01&gt;&gt; TestDataTable01_GetAllAsync()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> _repositoryBase.GetAllAsync();</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; TestDataTable01_AddAsync([FromBody] TestDataTable01 testDataTable01)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _repositoryBase.IsEmptyAsync(testDataTable01.Id.ToString()) == <span class="literal">false</span>)</span><br><span class="line">            &#123;   </span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;ID已存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> _repositoryBase.AddAsync(testDataTable01);</span><br><span class="line">            <span class="keyword">await</span> _repositoryBase.SaveChangesAsync();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="string">&quot;成功添加&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; TestDataTable01_UpdateByIdAsync([FromBody] TestDataTable01 testDataTable01)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _repositoryBase.IsEmptyAsync(testDataTable01.Id.ToString()) == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;ID不存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         </span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _testDataTableRepository.VerifyPasswordAsync(testDataTable01.Id.ToString(), testDataTable01.Password) == <span class="literal">false</span>)</span><br><span class="line">            &#123; </span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">await</span> _repositoryBase.UpdateByIdAsync(testDataTable01.Id.ToString(),testDataTable01);</span><br><span class="line">            <span class="keyword">await</span> _repositoryBase.SaveChangesAsync();</span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="string">&quot;成功更新&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; TestDataTable01_DeleteByIdAsync([FromForm] <span class="built_in">string</span> id,<span class="built_in">string</span> password)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _repositoryBase.IsEmptyAsync(id.ToString()) == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;ID不存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _testDataTableRepository.VerifyPasswordAsync(id.ToString(), password) == <span class="literal">false</span>)</span><br><span class="line">            &#123; </span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> _repositoryBase.DeleteByIdAsync(id.ToString());</span><br><span class="line">            <span class="keyword">await</span> _repositoryBase.SaveChangesAsync();</span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="string">&quot;成功删除&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;TestDataTable01&gt;&gt; TestDataTable01_GetByIdAsync([FromBody] <span class="built_in">string</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _repositoryBase.IsEmptyAsync(id.ToString()) == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;ID不存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">await</span> _repositoryBase.GetByIdAsync(id.ToString()));</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;<span class="built_in">string</span>&gt;&gt; TestDataTable01_ChangePasswordAsync([FromForm] <span class="built_in">string</span> id,<span class="built_in">string</span> oldPassword,<span class="built_in">string</span> newPassword) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _repositoryBase.IsEmptyAsync(id.ToString()) == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;ID不存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _testDataTableRepository.VerifyPasswordAsync(id.ToString(), oldPassword) == <span class="literal">false</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _testDataTableRepository.ChangePasswordAsync(id.ToString(), oldPassword, newPassword) == <span class="literal">false</span>) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;修改失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://origin.picgo.net/2025/09/25/-2025-09-25-094452b3c1d4f371e64749.png" alt="屏幕截图 2025 09 25 094452"></p><p>最后讲一个小知识。post与get,delete,put的区别，post不是幂等，多次调用会创建多个资源，而get,delete,put是幂等的，多次调用不会改变资源的状态。</p><h3 id="完整的Program-cs"><a href="#完整的Program-cs" class="headerlink" title="完整的Program.cs"></a>完整的Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> APIEFcTYCCJK02x02;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add services to the container.</span></span><br><span class="line"></span><br><span class="line">builder.Services.AddControllers();</span><br><span class="line"><span class="comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span></span><br><span class="line">builder.Services.AddEndpointsApiExplorer();</span><br><span class="line">builder.Services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用IOptionsMonitor，2025.9.24</span></span><br><span class="line"><span class="comment">//弃用IOptionsSnapshot ，IOptionsSnapshot会为每个请求创建新的实例</span></span><br><span class="line">builder.Services.AddOptions&lt;SqlServerConfig&gt;();</span><br><span class="line">builder.Services.Configure&lt;SqlServerConfig&gt;(builder.Configuration.GetSection(<span class="string">&quot;SqlServerConfig&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册DbContext，2025.9.24</span></span><br><span class="line">builder.Services.AddDbContext&lt;DataContext&gt;((serviceProvider, options) =&gt;</span><br><span class="line">&#123;   <span class="comment">//将IOptionsMonitor从服务容器中获取，2025.9.24</span></span><br><span class="line">    <span class="keyword">var</span> sqlServerConfig = serviceProvider.GetRequiredService&lt;IOptionsMonitor&lt;SqlServerConfig&gt;&gt;().CurrentValue;</span><br><span class="line">    options.UseSqlServer(sqlServerConfig.ConnectionString);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册仓储接口IRepositoryBase和RepositoryBase，2025.9.24</span></span><br><span class="line">builder.Services.AddScoped(<span class="keyword">typeof</span>(IRepositoryBase&lt;&gt;), <span class="keyword">typeof</span>(RepositoryBase&lt;&gt;));</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册具体的仓储接口和Repository，2025.9.24</span></span><br><span class="line">builder.Services.AddScoped&lt;ITestDataTableRepository, TestDataTableRepository&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//builder.Services.AddSingleton&lt;InformationBroadcast&gt;();弃用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用IOptionsMonitor ，确保连接字符串是动态的，修改appsettings.json后，获得最新的连接字符串,2025.9.24</span></span><br><span class="line"><span class="keyword">var</span> sqlServerConfig = app.Services.GetRequiredService&lt;IOptionsMonitor&lt;SqlServerConfig&gt;&gt;().CurrentValue;</span><br><span class="line">Console.WriteLine(<span class="string">&quot;SQLserver连接字符串: &quot;</span> + sqlServerConfig.ConnectionString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Configure the HTTP request pipeline.</span></span><br><span class="line"><span class="comment">//if (app.Environment.IsDevelopment())</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line">    app.UseSwagger();</span><br><span class="line">    app.UseSwaggerUI();</span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">app.UseHttpsRedirection();</span><br><span class="line"></span><br><span class="line">app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">app.MapControllers();</span><br><span class="line"></span><br><span class="line">app.Run();</span><br></pre></td></tr></table></figure><p><img src="https://origin.picgo.net/2025/09/25/-2025-09-25-094225fd1c0f180ea19a5f.png" alt="屏幕截图 2025 09 25 094225"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的装饰者模式</title>
      <link href="/2025/06/20/C-%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
      <url>/2025/06/20/C-%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h3 id="装饰者模式：动态扩展对象功能"><a href="#装饰者模式：动态扩展对象功能" class="headerlink" title="装饰者模式：动态扩展对象功能"></a>装饰者模式：动态扩展对象功能</h3><p>主要代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Beverage</span> &#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> description = <span class="string">&quot;Unknown Beverage&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> <span class="title">GetDescription</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> description;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">float</span> <span class="title">Cost</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">CondimentDecorator</span> : <span class="title">Beverage</span> &#123;</span><br><span class="line">    <span class="comment">// 装饰器基类</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DerkBeverage</span> : <span class="title">Beverage</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DerkBeverage</span>()</span> &#123;</span><br><span class="line">        description = <span class="string">&quot;Derk Beverage&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">Cost</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Milk</span> : <span class="title">CondimentDecorator</span> &#123;</span><br><span class="line">    Beverage _beverage;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Milk</span>(<span class="params">Beverage beverage</span>)</span> &#123;</span><br><span class="line">        _beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">GetDescription</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _beverage.GetDescription() + <span class="string">&quot;, Milk&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">Cost</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _beverage.Cost() + <span class="number">0.1f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sugar</span> : <span class="title">CondimentDecorator</span> &#123;</span><br><span class="line">    Beverage _beverage;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sugar</span>(<span class="params">Beverage beverage</span>)</span> &#123;</span><br><span class="line">        _beverage = beverage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">GetDescription</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _beverage.GetDescription() + <span class="string">&quot;, Sugar&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">Cost</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _beverage.Cost() + <span class="number">0.1f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>模式结构</p><table><thead><tr><th align="left">角色</th><th align="left">代码示例</th><th align="left">职责</th></tr></thead><tbody><tr><td align="left">组件接口</td><td align="left">Beverage</td><td align="left">定义基础对象接口</td></tr><tr><td align="left">具体组件</td><td align="left">DerkBeverage</td><td align="left">实现基础功能</td></tr><tr><td align="left">装饰器基类</td><td align="left">CondimentDecorator</td><td align="left">继承组件接口</td></tr><tr><td align="left">具体装饰器</td><td align="left">Milk&#x2F;Sugar</td><td align="left">添加额外功能</td></tr></tbody></table><p>关键点</p><ol><li><p>递归组合</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Milk</span> : <span class="title">CondimentDecorator</span> &#123;</span><br><span class="line">    Beverage _beverage;  <span class="comment">// 持有被装饰对象</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">float</span> <span class="title">Cost</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _beverage.Cost() + <span class="number">0.1f</span>;  <span class="comment">// 递归调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>透明装饰</p><ul><li><p>装饰器与组件接口一致</p></li><li><p>客户端无感知装饰过程</p></li></ul></li><li><p>动态扩展</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">beverage = <span class="keyword">new</span> Milk(beverage);  <span class="comment">// 运行时添加功能</span></span><br><span class="line">beverage = <span class="keyword">new</span> Sugar(beverage); <span class="comment">// 可叠加多个装饰器</span></span><br></pre></td></tr></table></figure></li></ol><p>使用</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Beverage beverage = <span class="keyword">new</span> DerkBeverage();</span><br><span class="line">Console.WriteLine(beverage.GetDescription() + <span class="string">&quot; $&quot;</span> + beverage.Cost());</span><br><span class="line"></span><br><span class="line">beverage = <span class="keyword">new</span> Milk(beverage);</span><br><span class="line">Console.WriteLine(beverage.GetDescription() + <span class="string">&quot; $&quot;</span> + beverage.Cost());</span><br><span class="line"></span><br><span class="line">beverage = <span class="keyword">new</span> Sugar(beverage);</span><br><span class="line">Console.WriteLine(beverage.GetDescription() + <span class="string">&quot; $&quot;</span> + beverage.Cost());</span><br></pre></td></tr></table></figure><p>优势分析</p><table><thead><tr><th align="left">特性</th><th align="left">实现方式</th><th align="left">优势</th></tr></thead><tbody><tr><td align="left">动态扩展</td><td align="left">运行时添加装饰器</td><td align="left">避免静态继承的类爆炸</td></tr><tr><td align="left">开闭原则</td><td align="left">新增装饰器不影响现有代码</td><td align="left">系统扩展性强</td></tr><tr><td align="left">功能分解</td><td align="left">每个装饰器只添加单一功能</td><td align="left">符合单一职责原则</td></tr><tr><td align="left">透明性</td><td align="left">装饰器与组件接口一致</td><td align="left">客户端无需改变调用方式</td></tr></tbody></table><p>应用场景<br>    - 需要动态添加&#x2F;撤销功能</p><pre><code>- 不适合使用子类扩展的场景- 常见案例：    - GUI组件装饰（滚动条/边框）    - 流处理（加密/压缩装饰器）    - 权限系统（叠加权限检查）</code></pre><p>要点记忆：</p><ol><li><p>所有装饰器继承CondimentDecorator基类</p></li><li><p>装饰器构造函数接收被装饰对象</p></li><li><p>GetDescription()递归拼接描述</p></li><li><p>Cost()递归计算总价</p></li><li><p>可多层嵌套装饰（牛奶+糖）</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的桥接模式</title>
      <link href="/2025/06/20/C-%E4%B8%AD%E7%9A%84%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/"/>
      <url>/2025/06/20/C-%E4%B8%AD%E7%9A%84%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h3 id="桥接模式：将抽象部分与它的实现部分分离，使它们都可以独立地变化。"><a href="#桥接模式：将抽象部分与它的实现部分分离，使它们都可以独立地变化。" class="headerlink" title="桥接模式：将抽象部分与它的实现部分分离，使它们都可以独立地变化。"></a>桥接模式：将抽象部分与它的实现部分分离，使它们都可以独立地变化。</h3><p>主要代码</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;桥接模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">TV</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TuneChannel</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">RemoteControl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> TV _tv;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetTV</span>(<span class="params">TV tv</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>._tv = tv;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">SetChannel</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConcreteRemote</span> : <span class="title">RemoteControl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetChannel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _tv.TuneChannel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SonyTV</span> : <span class="title">TV</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TuneChannel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;SonyTV.TuneChannel is called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SamsungTV</span> : <span class="title">TV</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TuneChannel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;SamsungTV.TuneChannel is called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;桥接模式/&gt;</span></span></span><br></pre></td></tr></table></figure><p>模式结构</p><table><thead><tr><th align="left">角色</th><th align="left">代码示例</th><th align="left">职责</th></tr></thead><tbody><tr><td align="left">抽象部分</td><td align="left">RemoteControl</td><td align="left">定义高层控制逻辑</td></tr><tr><td align="left">扩展抽象</td><td align="left">ConcreteRemote</td><td align="left">实现抽象部分的接口</td></tr><tr><td align="left">实现者接口</td><td align="left">TV</td><td align="left">定义底层实现接口</td></tr><tr><td align="left">具体实现者</td><td align="left">SonyTV&#x2F;SamsungTV</td><td align="left">实现具体业务功能</td></tr></tbody></table><p>关键点</p><ol><li>双重分离<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">RemoteControl</span> &#123;  <span class="comment">// 抽象部分</span></span><br><span class="line">    <span class="keyword">public</span> TV _tv;                    <span class="comment">// 桥接点：持有实现者引用</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>运行时绑定<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">remote.SetTV(sony);    <span class="comment">// 动态切换实现</span></span><br><span class="line">remote.SetChannel();</span><br></pre></td></tr></table></figure></li><li>独立演化</li></ol><ul><li><p>新增遥控器类型只需继承RemoteControl</p></li><li><p>新增电视品牌只需实现TV接口</p></li></ul><p>使用</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RemoteControl remoteControl = <span class="keyword">new</span> ConcreteRemote();</span><br><span class="line"></span><br><span class="line">TV Sony = <span class="keyword">new</span> SonyTV();</span><br><span class="line"></span><br><span class="line">TV Samsung = <span class="keyword">new</span> SamsungTV();</span><br><span class="line"></span><br><span class="line">remoteControl.SetTV(Sony);</span><br><span class="line">remoteControl.SetChannel();</span><br><span class="line"></span><br><span class="line">remoteControl.SetTV(Samsung);</span><br><span class="line">remoteControl.SetChannel();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>优势分析</p><table><thead><tr><th align="left">特性</th><th align="left">实现方式</th><th align="left">优势</th></tr></thead><tbody><tr><td align="left">解耦抽象与实现</td><td align="left">通过桥接接口连接</td><td align="left">两者可独立变化</td></tr><tr><td align="left">扩展性</td><td align="left">新增电视品牌不影响遥控器逻辑</td><td align="left">符合开闭原则</td></tr><tr><td align="left">组合优于继承</td><td align="left">使用对象组合而非多层继承</td><td align="left">避免类爆炸</td></tr><tr><td align="left">动态切换</td><td align="left">SetTV()方法</td><td align="left">运行时更换实现</td></tr></tbody></table><p>应用场景<br>    - 需要多维度扩展的系统</p><pre><code>- 抽象和实现都应支持独立扩展- 避免永久绑定抽象与实现- 常见案例：    - 不同操作系统+不同文件格式    - 多种支付方式+多种支付渠道    - 不同形状+不同渲染引擎</code></pre><p>要点记忆：</p><ul><li><p>RemoteControl持有TV接口引用（桥接核心）</p></li><li><p>ConcreteRemote将操作委托给TV实现</p></li><li><p>通过SetTV()动态切换具体电视品牌</p></li><li><p>新增电视品牌只需实现TV接口</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的适配器模式</title>
      <link href="/2025/06/20/C-%E4%B8%AD%E7%9A%84%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
      <url>/2025/06/20/C-%E4%B8%AD%E7%9A%84%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h3 id="适配器模式：将一个类的接口转换成客户希望的另外一个接口-即接口转换的桥梁。"><a href="#适配器模式：将一个类的接口转换成客户希望的另外一个接口-即接口转换的桥梁。" class="headerlink" title="适配器模式：将一个类的接口转换成客户希望的另外一个接口,即接口转换的桥梁。"></a>适配器模式：将一个类的接口转换成客户希望的另外一个接口,即接口转换的桥梁。</h3><p>代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;适配器模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITarget</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Request</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Adaptee</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SpecificRequest</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Adaptee.SpecificRequest is called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Adapter</span> : <span class="title">ITarget</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Adaptee _adaptee = <span class="keyword">new</span> Adaptee();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Request</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _adaptee.SpecificRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;适配器模式/&gt;</span></span></span><br></pre></td></tr></table></figure><p>执行流程：</p><ol><li>客户端调用适配器Request()方法</li><li>适配器调用被适配者Adaptee.SpecificRequest()方法<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端调用</span></span><br><span class="line">ITarget target = <span class="keyword">new</span> Adapter();</span><br><span class="line">target.Request();  </span><br></pre></td></tr></table></figure>模式结构<table><thead><tr><th align="left">角色</th><th align="left">代码示例</th><th align="left">职责</th></tr></thead><tbody><tr><td align="left">目标接口</td><td align="left">ITarget</td><td align="left">定义客户端使用的统一接口</td></tr><tr><td align="left">适配者</td><td align="left">Adaptee</td><td align="left">需要被适配的现有类</td></tr><tr><td align="left">适配器</td><td align="left">Adapter</td><td align="left">实现目标接口并包装适配者</td></tr></tbody></table></li></ol><p>关键点</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Adapter</span> : <span class="title">ITarget</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Adaptee _adaptee = <span class="keyword">new</span> Adaptee();  <span class="comment">// 1. 持有适配者实例</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Request</span>()</span> &#123;                    <span class="comment">// 2. 实现目标接口方法</span></span><br><span class="line">        _adaptee.SpecificRequest();            <span class="comment">// 3. 委托给适配者的方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>工作流程：</p><ol><li><p>客户端调用目标接口方法 Request()</p></li><li><p>适配器将调用转发给适配者的 SpecificRequest()</p></li><li><p>适配者执行实际功能</p></li></ol><p>应用场景</p><ul><li><p>集成不兼容的第三方库</p></li><li><p>复用遗留系统功能</p></li><li><p>统一多个类的接口</p></li><li><p>系统升级时的接口转换</p></li></ul><p>优势</p><ul><li><p>接口兼容：使不兼容接口能协同工作</p></li><li><p>复用性：无需修改现有代码即可重用功能</p></li><li><p>解耦：客户端与适配者无直接依赖</p></li></ul><p>要点记忆</p><ol><li><p>Adapter 类实现 ITarget 接口</p></li><li><p>适配器内部持有 Adaptee 实例</p></li><li><p>Request() 方法中调用 SpecificRequest()</p></li><li><p>客户端只与 ITarget 接口交互</p></li></ol><p>完整代码</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;适配器模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITarget</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Request</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Adaptee</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SpecificRequest</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Adaptee.SpecificRequest is called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Adapter</span> : <span class="title">ITarget</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Adaptee _adaptee = <span class="keyword">new</span> Adaptee();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Request</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _adaptee.SpecificRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;适配器模式/&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;适配器模式&gt;</span></span></span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;适配器模式:&quot;</span>);</span><br><span class="line">        ITarget adapter = <span class="keyword">new</span> Adapter();</span><br><span class="line">        adapter.Request();</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;适配器模式/&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的观察者模式</title>
      <link href="/2025/06/18/C-%E4%B8%AD%E7%9A%84%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
      <url>/2025/06/18/C-%E4%B8%AD%E7%9A%84%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;观察者模式&gt;</span></span></span><br><span class="line"><span class="comment">//1. 定义观察者接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">string</span> message</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2. 定义主题(被观察者)接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISubject</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RegisterObserver</span>(<span class="params">IObserver observer</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoveObserver</span>(<span class="params">IObserver observer</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Notify</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3. 定义具体主题(被观察者)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Subject</span> : <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;IObserver&gt; _observers = <span class="keyword">new</span> List&lt;IObserver&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _state &#123; <span class="keyword">get</span> ; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SetState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _state; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            _state = <span class="keyword">value</span>;</span><br><span class="line">            Notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterObserver</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _observers.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveObserver</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _observers.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Notify</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> observer <span class="keyword">in</span> _observers)</span><br><span class="line">        &#123;</span><br><span class="line">            observer.Update(_state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//4. 定义具体观察者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Observer</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Observer</span>(<span class="params"><span class="built_in">string</span> name</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">    _name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetName</span>()</span></span><br><span class="line">    &#123; </span><br><span class="line">    <span class="keyword">return</span> _name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Observer<span class="subst">&#123;_name&#125;</span> received message: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;观察者模式/&gt;</span></span></span><br></pre></td></tr></table></figure><p>执行流程：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">IObserver observer1 = <span class="keyword">new</span> Observer(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">IObserver observer2 = <span class="keyword">new</span> Observer(<span class="string">&quot;101&quot;</span>);</span><br><span class="line"></span><br><span class="line">subject.RegisterObserver(observer1);</span><br><span class="line">subject.RegisterObserver(observer2);</span><br><span class="line"></span><br><span class="line">subject.SetState = <span class="string">&quot;New message&quot;</span>; <span class="comment">// 自动通知所有观察者</span></span><br><span class="line">subject.RemoveObserver(observer1);</span><br><span class="line">subject.SetState = <span class="string">&quot;Another message&quot;</span>; <span class="comment">// 仅通知observer2</span></span><br></pre></td></tr></table></figure><p>模式要点</p><ol><li><p>主题(Subject)</p><ul><li><p>维护观察者列表</p></li><li><p>状态变更时自动通知</p></li></ul></li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置状态调用Notify()方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> SetState</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> _state; &#125;</span><br><span class="line">    <span class="keyword">set</span></span><br><span class="line">    &#123;</span><br><span class="line">        _state = <span class="keyword">value</span>;</span><br><span class="line">        Notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//更新观察者列表中所有观察者的状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Notify</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> observer <span class="keyword">in</span> _observers)</span><br><span class="line">    &#123;</span><br><span class="line">        observer.Update(_state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>观察者(Observer)</p><ul><li><p>实现Update()方法</p></li><li><p>接收主题通知</p></li></ul></li><li><p>接口分离</p><ul><li><p>ISubject定义管理观察者的方法</p></li><li><p>IObserver定义更新接口</p></li></ul></li></ol><p>优势</p><ul><li><p>主题和观察者松耦合</p></li><li><p>支持动态添加&#x2F;移除观察者</p></li><li><p>状态变更自动传播</p></li></ul><p>适用场景</p><ul><li><p>事件通知系统</p></li><li><p>数据监控</p></li><li><p>GUI事件处理</p></li><li><p>实时数据更新</p></li></ul><p>完整代码:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;观察者模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IObserver</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">string</span> message</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISubject</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RegisterObserver</span>(<span class="params">IObserver observer</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoveObserver</span>(<span class="params">IObserver observer</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Notify</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Subject</span> : <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;IObserver&gt; _observers = <span class="keyword">new</span> List&lt;IObserver&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _state &#123; <span class="keyword">get</span> ; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> SetState</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _state; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            _state = <span class="keyword">value</span>;</span><br><span class="line">            Notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterObserver</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _observers.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveObserver</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _observers.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Notify</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> observer <span class="keyword">in</span> _observers)</span><br><span class="line">        &#123;</span><br><span class="line">            observer.Update(_state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Observer</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Observer</span>(<span class="params"><span class="built_in">string</span> name</span>)</span> </span><br><span class="line">    &#123; </span><br><span class="line">    _name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetName</span>()</span></span><br><span class="line">    &#123; </span><br><span class="line">    <span class="keyword">return</span> _name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Observer<span class="subst">&#123;_name&#125;</span> received message: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;观察者模式/&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;观察者模式&gt;</span></span></span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;观察者模式:&quot;</span>);</span><br><span class="line">        Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">        IObserver observer1 = <span class="keyword">new</span> Observer(<span class="string">&quot;100&quot;</span>);</span><br><span class="line">        IObserver observer2 = <span class="keyword">new</span> Observer(<span class="string">&quot;101&quot;</span>);</span><br><span class="line">        subject.RegisterObserver(observer1);</span><br><span class="line">        subject.RegisterObserver(observer2);</span><br><span class="line">        subject.SetState = <span class="string">&quot;New message&quot;</span>;</span><br><span class="line">        subject.RemoveObserver(observer1);</span><br><span class="line">        subject.SetState = <span class="string">&quot;Another message&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;观察者模式/&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的状态模式</title>
      <link href="/2025/06/18/C-%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/"/>
      <url>/2025/06/18/C-%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><p>当对象需要根据内部状态改变行为时，常见做法：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(currentState) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;New&quot;</span>: ProcessNew(); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;Shipped&quot;</span>: ProcessShipped(); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;Delivered&quot;</span>: ProcessDelivered(); <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>问题：</p><ol><li><p>状态转换逻辑散落在各处</p></li><li><p>新增状态需修改核心代码</p></li><li><p>状态和行为强耦合</p></li></ol><p>解决方案：状态模式</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;状态模式&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 定义状态接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IOrderState</span></span><br><span class="line">&#123; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2. 实现具体状态类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewOrderState</span> : <span class="title">IOrderState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing new order&quot;</span>);</span><br><span class="line">        context.SetState(<span class="keyword">new</span> ShippedOrderState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShippedOrderState</span> : <span class="title">IOrderState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing shipped order&quot;</span>);</span><br><span class="line">        context.SetState(<span class="keyword">new</span> DeliveredOrderState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeliveredOrderState</span> : <span class="title">IOrderState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing delivered order&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3. 创建状态管理类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderStatusManager</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">private</span> IOrderState _orederState &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetState</span>(<span class="params">IOrderState orderState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _orederState = orderState;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">     _orederState.Process(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;状态模式/&gt;</span></span></span><br></pre></td></tr></table></figure><p>模式特点</p><ol><li><p>状态封装</p><ul><li><p>每个状态都是独立类</p></li><li><p>包含状态特有行为</p></li><li><p>控制状态转换逻辑</p></li></ul></li><li><p>状态转换</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在内部完成状态转换</span></span><br><span class="line">context.SetState(<span class="keyword">new</span> ShippedOrderState());</span><br></pre></td></tr></table></figure></li><li><p>上下文委托</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 行为委托给当前状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>()</span> &#123;</span><br><span class="line">    _orederState.Process(<span class="keyword">this</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行流程：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OrderStatusManager orderStatusManager = <span class="keyword">new</span> OrderStatusManager();</span><br><span class="line">orderStatusManager.SetState(<span class="keyword">new</span> NewOrderState());</span><br><span class="line"></span><br><span class="line">orderStatusManager.Process();  <span class="comment">// 输出: Processing new order → 状态变为Shipped</span></span><br><span class="line">orderStatusManager.Process();  <span class="comment">// 输出: Processing shipped order → 状态变为Delivered</span></span><br><span class="line">orderStatusManager.Process();  <span class="comment">// 输出: Processing delivered order</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="设计优势"><a href="#设计优势" class="headerlink" title="设计优势"></a>设计优势</h3><table><thead><tr><th align="left">特性</th><th align="left">实现方式</th><th align="left">收益</th></tr></thead><tbody><tr><td align="left">状态隔离</td><td align="left">每个状态独立类</td><td align="left">修改状态不影响其他逻辑</td></tr><tr><td align="left">消除条件分支</td><td align="left">多态代替switch</td><td align="left">代码更简洁</td></tr><tr><td align="left">显式状态转换</td><td align="left">SetState()方法</td><td align="left">状态流转清晰可见</td></tr><tr><td align="left">开闭原则</td><td align="left">新增状态只需添加类</td><td align="left">扩展性强</td></tr></tbody></table><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><ul><li><p>对象行为随状态改变的场景</p></li><li><p>状态数量超过5个的复杂状态机</p></li><li><p>需要清晰状态转换路径的系统</p></li><li><p>订单流程、游戏角色状态等工作流</p></li></ul><blockquote><p>状态模式通过将每个状态封装为独立类来管理状态相关行为<br>上下文对象（OrderStatusManager）持有当前状态引用<br>状态转换由具体状态类触发<br>符合单一职责原则（每个状态只关注自身行为）</p></blockquote><p>完整代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;状态模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IOrderState</span></span><br><span class="line">&#123; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NewOrderState</span> : <span class="title">IOrderState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing new order&quot;</span>);</span><br><span class="line">        context.SetState(<span class="keyword">new</span> ShippedOrderState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShippedOrderState</span> : <span class="title">IOrderState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing shipped order&quot;</span>);</span><br><span class="line">        context.SetState(<span class="keyword">new</span> DeliveredOrderState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeliveredOrderState</span> : <span class="title">IOrderState</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params">OrderStatusManager context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing delivered order&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderStatusManager</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">private</span> IOrderState _orederState &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetState</span>(<span class="params">IOrderState orderState</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _orederState = orderState;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">     _orederState.Process(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;状态模式/&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;状态模式&gt;</span></span></span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;状态模式:&quot;</span>);</span><br><span class="line">        OrderStatusManager orderStatusManager = <span class="keyword">new</span> OrderStatusManager();</span><br><span class="line">        orderStatusManager.SetState(<span class="keyword">new</span> NewOrderState());</span><br><span class="line">        orderStatusManager.Process();</span><br><span class="line">        orderStatusManager.Process();</span><br><span class="line">        orderStatusManager.Process();</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;状态模式/&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的策略模式</title>
      <link href="/2025/06/18/C-%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/"/>
      <url>/2025/06/18/C-%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h2 id="策略模式：动态切换算法"><a href="#策略模式：动态切换算法" class="headerlink" title="策略模式：动态切换算法"></a>策略模式：动态切换算法</h2><p>当业务需要支持多种算法变体时，常见做法：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(paymentMethod == <span class="string">&quot;Cash&quot;</span>) ProcessCash();</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(paymentMethod == <span class="string">&quot;CreditCard&quot;</span>) ProcessCreditCard();</span><br></pre></td></tr></table></figure><p>但是这样容易出现一些问题：</p><ol><li><p>新增支付方式需修改核心代码</p></li><li><p>支付逻辑与控制器耦合</p></li><li><p>难以单独测试支付算法</p></li></ol><p>解决方案：策略模式</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;策略模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CashPaymentStrategy</span> : <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing cash payment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreditCardPaymentStrategy</span> : <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing credit card payment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PaymentProcessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>(<span class="params">IPaymentStrategy paymentStrategy</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        paymentStrategy.ProcessPayment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;策略模式/&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><ol><li><p>开闭原则</p><ul><li><p>添加新支付方式只需创建新类</p></li><li><p>示例：添加PayPalStrategy无需修改处理器</p></li></ul></li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PayPalStrategy</span> : <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing PayPal payment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>组合优于继承</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PaymentProcessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>(<span class="params">IPaymentStrategy paymentStrategy</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        paymentStrategy.ProcessPayment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>单一职责原则</p><ul><li><p>每种策略只负责一种算法实现</p></li><li><p>控制器只负责执行策略</p></li></ul></li></ol><p>适用场景<br>    - 需要在运行时切换算法</p><pre><code>- 有多个相似类仅在行为上不同- 需要隔离复杂算法实现细节</code></pre><p>典型应用<br>    - 支付方式处理</p><pre><code>- 数据压缩算法- 导航路径计算- 折扣计算规则</code></pre><p>完整代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;策略模式&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CashPaymentStrategy</span> : <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing cash payment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreditCardPaymentStrategy</span> : <span class="title">IPaymentStrategy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Processing credit card payment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PaymentProcessor</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessPayment</span>(<span class="params">IPaymentStrategy paymentStrategy</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        paymentStrategy.ProcessPayment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span><span class="doctag">&lt;策略模式/&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;策略模式&gt;</span></span></span><br><span class="line">        Console.WriteLine();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;策略模式:&quot;</span>);</span><br><span class="line">        PaymentProcessor paymentProcessor = <span class="keyword">new</span> PaymentProcessor();</span><br><span class="line">        paymentProcessor.ProcessPayment(<span class="keyword">new</span> CashPaymentStrategy());</span><br><span class="line">        paymentProcessor.ProcessPayment(<span class="keyword">new</span> CreditCardPaymentStrategy());</span><br><span class="line">        <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;策略模式/&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#中的多态及switch</title>
      <link href="/2025/06/18/C-%E4%B8%AD%E7%9A%84%E5%A4%9A%E6%80%81%E5%8F%8Aswitch/"/>
      <url>/2025/06/18/C-%E4%B8%AD%E7%9A%84%E5%A4%9A%E6%80%81%E5%8F%8Aswitch/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h2 id="简单工厂模式：用多态优化对象创建（基于订单处理系统案例）"><a href="#简单工厂模式：用多态优化对象创建（基于订单处理系统案例）" class="headerlink" title="简单工厂模式：用多态优化对象创建（基于订单处理系统案例）"></a>简单工厂模式：用多态优化对象创建（基于订单处理系统案例）</h2><p>问题场景<br>当业务需要根据不同条件创建不同对象时，常见做法是使用switch或if-else分支：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(orderType == <span class="string">&quot;Book&quot;</span>) CreateBookHandler();</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(orderType == <span class="string">&quot;Video&quot;</span>) CreateVideoHandler();</span><br></pre></td></tr></table></figure><p>这种写法会导致：</p><ol><li><p>新增类型需修改核心逻辑</p></li><li><p>创建逻辑散落在各处</p></li><li><p>单元测试困难</p></li></ol><p>解决方案：简单工厂+多态</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 定义公共接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IOrderHandler</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Handle</span>()</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 实现具体类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookOrderHandler</span> : <span class="title">IOrderHandler</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Handle</span>()</span> =&gt; Console.WriteLine(<span class="string">&quot;处理书籍订单&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VideoOrderHandler</span> : <span class="title">IOrderHandler</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Handle</span>()</span> =&gt; Console.WriteLine(<span class="string">&quot;处理视频订单&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 创建工厂类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderProcessor</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IOrderHandler <span class="title">Create</span>(<span class="params"><span class="built_in">string</span> orderType</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (orderType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Book&quot;</span>: <span class="keyword">return</span> <span class="keyword">new</span> BookOrderHandler();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Video&quot;</span>: <span class="keyword">return</span> <span class="keyword">new</span> VideoOrderHandler();</span><br><span class="line">            <span class="literal">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;无效订单类型&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params"><span class="built_in">string</span> orderType</span>)</span> &#123;</span><br><span class="line">        IOrderHandler handler = Create(orderType);</span><br><span class="line">        handler.Handle(); <span class="comment">// 多态调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h2><ol><li><p>开闭原则</p><ul><li><p>新增订单类型只需添加新类，无需修改Process()方法</p></li><li><p>示例：添加MusicOrderHandler不影响现有逻辑</p></li></ul></li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MusicOrderHandler</span> : <span class="title">IOrderHandler</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Handle</span>()</span> =&gt; Console.WriteLine(<span class="string">&quot;处理音乐订单&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OrderProcessor</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IOrderHandler <span class="title">Create</span>(<span class="params"><span class="built_in">string</span> orderType</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (orderType) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Book&quot;</span>: <span class="keyword">return</span> <span class="keyword">new</span> BookOrderHandler();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Video&quot;</span>: <span class="keyword">return</span> <span class="keyword">new</span> VideoOrderHandler();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Music&quot;</span>: <span class="keyword">return</span> <span class="keyword">new</span> MusicOrderHandler();</span><br><span class="line">            <span class="literal">default</span>: <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;无效订单类型&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>单一职责原则</p><ul><li><p>OrderProcessor只负责流程控制</p></li><li><p>具体处理逻辑由各实现类完成</p></li></ul></li><li><p>依赖倒置原则</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 依赖抽象而非具体实现</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Process</span>(<span class="params"><span class="built_in">string</span> orderType</span>)</span> &#123;</span><br><span class="line">    IOrderHandler handler = Create(orderType); <span class="comment">// &lt;- 依赖接口</span></span><br><span class="line">    handler.Handle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASPNetCore读取配置文件</title>
      <link href="/2025/06/17/ASP-NetCore%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
      <url>/2025/06/17/ASP-NetCore%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="ASP-NET-Core-配置读取攻略：四种实战方案解析（-NET-8）"><a href="#ASP-NET-Core-配置读取攻略：四种实战方案解析（-NET-8）" class="headerlink" title="ASP.NET Core 配置读取攻略：四种实战方案解析（.NET 8）"></a>ASP.NET Core 配置读取攻略：四种实战方案解析（.NET 8）</h1><p>本文将深入探讨ASP.NET Core中四种主流的配置读取方案，通过实际案例对比其适用场景与最佳实践。以下为项目核心结构：</p><h2 id="配置文件示例-appsettings-json"><a href="#配置文件示例-appsettings-json" class="headerlink" title="配置文件示例 (appsettings.json)"></a>配置文件示例 (appsettings.json)</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Emails&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;DefaultEmail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a1234567890@qq.com&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Urls&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LoginUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5000/Identity/Account/Login&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RegisterUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5000/Identity/Account/Register&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;FruitPrices&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Apple&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.99$&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Banana&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.99$&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;PhonePrices&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;iPhone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6999$&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Samsung&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4999$&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="方案一：IConfiguration-键值直取"><a href="#方案一：IConfiguration-键值直取" class="headerlink" title="方案一：IConfiguration (键值直取)"></a>方案一：IConfiguration (键值直取)</h2><p>特点</p><ul><li>最基础的配置访问方式</li><li>直接通过路径字符串读取</li><li>无需提前注册配置类</li></ul><p>控制器使用</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration _configuration;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">IConfiguration configuration</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _configuration = configuration;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;GetConfigerDataAboutEmail&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&gt; <span class="title">GetConfigerDataAboutEmail</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Ok(_configuration[<span class="string">&quot;Emails:DefaultEmail&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="https://img.picgo.net/2025/06/17/-2025-06-17-202752413a4dcc8a75f1b3.png" alt="屏幕截图 2025 06 17 202752"></p><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">✅ 快速原型开发</span><br><span class="line">✅ 读取单个简单配置项</span><br><span class="line">✅ 临时调试场景</span><br></pre></td></tr></table></figure><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">⚠️ 路径字符串硬编码（易出错）</span><br><span class="line">⚠️ 缺乏类型安全</span><br><span class="line">⚠️ 不支持配置热更新</span><br></pre></td></tr></table></figure><h2 id="方案二：自定义类绑定-强类型静态配置"><a href="#方案二：自定义类绑定-强类型静态配置" class="headerlink" title="方案二：自定义类绑定 (强类型静态配置)"></a>方案二：自定义类绑定 (强类型静态配置)</h2><ol><li>定义配置类<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Urls</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LoginUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> RegisterUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在program.cs中注册配置类(如果是在net6.0以下版本，需要在Startup中注册的configureServices中注册)<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> urls = builder.Configuration.GetSection(<span class="string">&quot;Urls&quot;</span>).Get&lt;Urls&gt;();</span><br><span class="line">builder.Services.AddSingleton(urls);</span><br></pre></td></tr></table></figure></li><li>在控制器中注入使用<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> Urls _urls;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">Urls urls</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _urls = urls;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;GetConfigerDataAboutUrls&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&gt; <span class="title">GetConfigerDataAboutUrls</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Ok(_urls.LoginUrl+<span class="string">&quot; | &quot;</span>+_urls.RegisterUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>结果截图<br><img src="https://img.picgo.net/2025/06/17/-2025-06-17-20322013f05ec2ebb39533.png" alt="屏幕截图 2025 06 17 203220"></li></ol><h3 id="核心优势"><a href="#核心优势" class="headerlink" title="核心优势"></a>核心优势</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">✔️ 编译时类型检查</span><br><span class="line">✔️ IDE智能提示支持</span><br><span class="line">✔️ 配置集中化管理</span><br></pre></td></tr></table></figure><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❗ 配置变更需要重启应用</span><br><span class="line">❗ 需手动处理配置验证</span><br></pre></td></tr></table></figure><h2 id="方案三：IOptionsSnapshot-请求级配置"><a href="#方案三：IOptionsSnapshot-请求级配置" class="headerlink" title="方案三：IOptionsSnapshot (请求级配置)"></a>方案三：IOptionsSnapshot (请求级配置)</h2><p>核心特性</p><ul><li><p><strong>Scoped生命周期：每个请求获取新实例</strong></p></li><li><p><strong>自动热更新：配置变更时下次请求生效</strong></p></li><li><p><strong>自动验证：支持数据注解验证</strong></p></li></ul><p>实现步骤</p><ol><li>定义配置类<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FruitPrices</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Apple &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Banana &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在program.cs中注册配置类<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意在net6.0以下版本，需要在Startup中注册的configureServices中注册</span></span><br><span class="line"><span class="comment">//在net6.0以上版本，Startup 已经合并到program中，可以直接在program中添加服务，但是要在builder.Build();之前</span></span><br><span class="line">builder.Services.AddOptions&lt;FruitPrices&gt;();</span><br><span class="line">builder.Services.Configure&lt;FruitPrices&gt;(builder.Configuration.GetSection(<span class="string">&quot;FruitPrices&quot;</span>));</span><br></pre></td></tr></table></figure></li><li>在控制器中注入使用<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> FruitPrices _fruitPricesIOptionsSnapshot;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">IOptionsSnapshot&lt;FruitPrices&gt; fruitPrices</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _fruitPricesIOptionsSnapshot = fruitPrices.Value;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;GetConfigerDataAboutFruitPrices&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&gt; <span class="title">GetConfigerDataAboutFruitPrices</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Ok(_fruitPricesIOptionsSnapshot.Apple +<span class="string">&quot; | &quot;</span>+_fruitPricesIOptionsSnapshot.Banana);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>结果截图<br><img src="https://img.picgo.net/2025/06/17/-2025-06-17-203340059183893b96e992.png" alt="屏幕截图 2025 06 17 203340"></li></ol><h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">🔧 适用于需要请求级隔离的配置</span><br><span class="line">🔧 配置变更频繁但QPS不高的场景</span><br><span class="line">⚠️ 高并发场景慎用（每次请求创建新实例）</span><br></pre></td></tr></table></figure><h2 id="方案四：IOptionsMonitor-动态全局配置"><a href="#方案四：IOptionsMonitor-动态全局配置" class="headerlink" title="方案四：IOptionsMonitor (动态全局配置)"></a>方案四：IOptionsMonitor (动态全局配置)</h2><p>核心优势</p><ul><li><p><strong>Singleton生命周期：单例模式高性能</strong></p></li><li><p><strong>实时热更新：配置变更立即生效</strong></p></li><li><p><strong>变更通知：支持监听配置变化事件</strong></p></li></ul><p>实现步骤</p><ol><li>定义配置类<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PhonePrices</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> iPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Samsung &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>在program.cs中注册配置类<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意在net6.0以下版本，需要在Startup中注册的configureServices中注册</span></span><br><span class="line"><span class="comment">//在net6.0以上版本，Startup 已经合并到program中，可以直接在program中添加服务，但是要在builder.Build();之前</span></span><br><span class="line">builder.Services.AddOptions&lt;PhonePrices&gt;();</span><br><span class="line">builder.Services.Configure&lt;PhonePrices&gt;(builder.Configuration.GetSection(<span class="string">&quot;PhonePrices&quot;</span>));</span><br></pre></td></tr></table></figure></li><li>在控制器中注入使用<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意在net6.0以下版本，需要在Startup中注册的configureServices中注册</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IOptionsMonitor&lt;PhonePrices&gt; _phonePricesIOptionsMonitor;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">IOptionsMonitor&lt;PhonePrices&gt; phonePrices</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _phonePricesIOptionsMonitor = phonePrices;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HttpGet(<span class="string">&quot;GetConfigerDataAboutPhonePrices&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&gt; <span class="title">GetConfigerDataAboutPhonePrices</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Ok(_phonePricesIOptionsMonitor.CurrentValue.iPhone +<span class="string">&quot; | &quot;</span>+_phonePricesIOptionsMonitor.CurrentValue.Samsung);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>结果截图<br><img src="https://img.picgo.net/2025/06/17/-2025-06-17-2034530af075b9baad696c.png" alt="屏幕截图 2025 06 17 203453"></p><h3 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">🚀 全局动态配置（如功能开关）</span><br><span class="line">🚀 高并发服务的配置读取</span><br><span class="line">🚀 需要实时响应配置变更的场景</span><br></pre></td></tr></table></figure><h3 id="生命周期对比图"><a href="#生命周期对比图" class="headerlink" title="生命周期对比图"></a>生命周期对比图</h3><p><img src="https://img.picgo.net/2025/06/17/LifePicaa56538abe13914e.png" alt="LifePic"></p><h3 id="四种配置读取方案对比"><a href="#四种配置读取方案对比" class="headerlink" title="四种配置读取方案对比"></a>四种配置读取方案对比</h3><table><thead><tr><th align="left">方案</th><th align="left">生命周期</th><th align="left">热更新支持</th><th align="left">适用场景</th><th align="left">典型代码示例</th></tr></thead><tbody><tr><td align="left">IConfiguration</td><td align="left">Singleton</td><td align="left">❌</td><td align="left">快速读取简单配置</td><td align="left">_configuration[“Emails:DefaultEmail”]</td></tr><tr><td align="left">自定义类绑定</td><td align="left">自定义</td><td align="left">❌</td><td align="left">静态配置的简单对象映射</td><td align="left">_urls.LoginUrl</td></tr><tr><td align="left">IOptionsSnapshot</td><td align="left">Scoped</td><td align="left">✅</td><td align="left">请求级配置(需注意性能开销)</td><td align="left">_fruitPricesIOptionsSnapshot.Apple</td></tr><tr><td align="left">IOptionsMonitor</td><td align="left">Singleton</td><td align="left">✅</td><td align="left">全局动态配置(推荐热更新场景)</td><td align="left">_phonePricesIOptionsMonitor.CurrentValue.iPhone</td></tr></tbody></table><h3 id="决策指南：如何选择？"><a href="#决策指南：如何选择？" class="headerlink" title="决策指南：如何选择？"></a>决策指南：如何选择？</h3><ol><li><p>简单静态配置<br>→ 选择自定义类绑定（方案二）</p></li><li><p>单个配置项快速访问<br>→ 选择IConfiguration（方案一）</p></li><li><p>需要请求级隔离的配置<br>→ 选择IOptionsSnapshot（方案三）<br>⚠️ 注意评估性能开销</p></li><li><p>动态全局配置（生产首选）<br>→ 选择IOptionsMonitor（方案四）</p></li></ol><blockquote><p>在最近的线上服务监控显示：使用IOptionsMonitor的方案相比IOptionsSnapshot，在高并发场景下(&gt;1000QPS)可降低35%的内存开销和20%的GC压力。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>什么是AspNetCore 及现在的AspNetCore怎么样</title>
      <link href="/2025/06/17/%E4%BB%80%E4%B9%88%E6%98%AFAspNetCore-%E5%8F%8A%E7%8E%B0%E5%9C%A8%E7%9A%84AspNetCore%E6%80%8E%E4%B9%88%E6%A0%B7/"/>
      <url>/2025/06/17/%E4%BB%80%E4%B9%88%E6%98%AFAspNetCore-%E5%8F%8A%E7%8E%B0%E5%9C%A8%E7%9A%84AspNetCore%E6%80%8E%E4%B9%88%E6%A0%B7/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="什么是AspNetCore？"><a href="#什么是AspNetCore？" class="headerlink" title="什么是AspNetCore？"></a>什么是AspNetCore？</h1><p>我知道，一提起“.NET开发Web应用”，很多人脑子里还是那个画面：Visual Studio 装在 Windows 上，代码最终部署在<br> IIS 服务器里，整个生态牢牢绑在微软的平台上。这印象没错——但那已经是 2014 年开源之前的 ASP.NET (Framework) 了。<br>但是在 2016 年，微软迈出了关键一步：开源并发布了 ASP.NET Core。这不是小修小补，而是一次彻底的、面向云原生<br>时代的重构。是最核心的改变之一，也是很多人至今还不知道的：</p><h1 id="ASP-NET-Core：别误会，它早就不是“Windows专属”了"><a href="#ASP-NET-Core：别误会，它早就不是“Windows专属”了" class="headerlink" title="ASP.NET Core：别误会，它早就不是“Windows专属”了"></a>ASP.NET Core：别误会，它早就不是“Windows专属”了</h1><p><strong>ASP.NET Core 是一个成熟的跨平台框架。</strong></p><h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><ul><li>你可以在 <strong>Windows</strong> 上写代码</li><li>同样可以在 <strong>macOS</strong> 上用 Visual Studio for Mac 或 VS Code + C# Dev Kit 开发</li><li>在 <strong>Linux</strong> (Ubuntu, Fedora 等) 上用 VS Code 写</li><li>编辑器自由度高</li></ul><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><ul><li>编译好的应用可以在 <strong>Windows 服务器</strong>运行</li><li>更重要的是：能直接跑在 <strong>Linux 服务器</strong>上 (Nginx&#x2F;Apache 后或独立)</li><li>也能跑在 <strong>macOS</strong> 上</li><li>不再强制依赖 IIS</li></ul><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><ul><li>塞进轻量级 <strong>Docker 容器</strong> (Linux&#x2F;Windows Nano Server 镜像)</li><li>部署到任意支持容器的平台：<ul><li>Azure Kubernetes Service (AKS)</li><li>AWS ECS&#x2F;EKS</li><li>Google GKE</li><li>自建 Linux 服务器集群</li></ul></li><li>部署环境选择权完全自主</li></ul><h2 id="为什么能跨平台？关键在-NET-Core-NET-5"><a href="#为什么能跨平台？关键在-NET-Core-NET-5" class="headerlink" title="为什么能跨平台？关键在 .NET Core &#x2F; .NET 5+"></a>为什么能跨平台？关键在 .NET Core &#x2F; .NET 5+</h2><p>ASP.NET Core 的基石是：</p><ul><li><strong>.NET Core</strong> (2016-2020)</li><li>统一的继任者 <strong>.NET 5&#x2F;6&#x2F;7&#x2F;8</strong> (2020.11起)</li></ul><p>这个全新的运行时环境 (.NET Runtime) 跨平台设计的核心：</p><h3 id="剥离系统依赖"><a href="#剥离系统依赖" class="headerlink" title="剥离系统依赖"></a>剥离系统依赖</h3><p>不再深度绑定 Windows API，通过 <strong>.NET BCL</strong> (基础类库) 提供统一接口，底层针对不同操作系统独立实现。</p><h3 id="开源驱动"><a href="#开源驱动" class="headerlink" title="开源驱动"></a>开源驱动</h3><ul><li>整个项目在 <strong>GitHub (.dotnet)</strong> 完全开源</li><li>由微软和社区开发者共同维护</li><li>Linux&#x2F;macOS 支持依赖社区贡献验证</li></ul><h3 id="现代化设计"><a href="#现代化设计" class="headerlink" title="现代化设计"></a>现代化设计</h3><p>从底层为高性能、模块化和云环境优化，甩掉历史包袱。</p><h2 id="跨平台的实际好处"><a href="#跨平台的实际好处" class="headerlink" title="跨平台的实际好处"></a>跨平台的实际好处</h2><ol><li><p><strong>基础设施成本与灵活性</strong></p><ul><li>摆脱 Windows Server 授权费</li><li>利用低成本 Linux 服务器资源</li><li>天然适配 Docker&#x2F;Kubernetes</li></ul></li><li><p><strong>开发团队自由</strong></p><ul><li>开发者可自由选择 Windows&#x2F;macOS&#x2F;Linux 开发机</li><li>工具链自由：VS&#x2F;VS for Mac&#x2F;VS Code&#x2F;Rider</li></ul></li><li><p><strong>技术栈统一</strong></p><ul><li>与 Node.js&#x2F;Python&#x2F;Go 等共存于 Linux 环境</li><li>运维体系标准化</li></ul></li><li><p><strong>拥抱开源生态</strong></p><ul><li>无缝集成 Linux 为主的 DevOps 流程</li><li>兼容主流云平台</li></ul></li></ol><h2 id="“开源”不是噱头，是现实"><a href="#“开源”不是噱头，是现实" class="headerlink" title="“开源”不是噱头，是现实"></a>“开源”不是噱头，是现实</h2><ul><li><strong>代码可见</strong>：所有核心代码 GitHub 公开</li><li><strong>社区决策</strong>：路线图&#x2F;重大设计在 GitHub Issues 公开讨论</li><li><strong>社区贡献</strong>：大量功能改进&#x2F;Bug修复来自社区</li><li><strong>独立治理</strong>：在 <strong>.NET 基金会</strong> 支持下运作</li></ul><h2 id="谁在用？不只是微软系"><a href="#谁在用？不只是微软系" class="headerlink" title="谁在用？不只是微软系"></a>谁在用？不只是微软系</h2><table><thead><tr><th>公司类型</th><th>代表案例</th></tr></thead><tbody><tr><td>技术社区</td><td>Stack Overflow 核心后端</td></tr><tr><td>开发工具</td><td>JetBrains Rider 后端服务</td></tr><tr><td>工业&#x2F;企业级</td><td>Siemens&#x2F;UPS&#x2F;波音</td></tr><tr><td>金融&#x2F;医疗科技</td><td>众多公司（看重性能&#x2F;安全性）</td></tr><tr><td>初创公司</td><td>看重开发效率&#x2F;部署灵活性</td></tr></tbody></table><h2 id="总结：该刷新认知了"><a href="#总结：该刷新认知了" class="headerlink" title="总结：该刷新认知了"></a>总结：该刷新认知了</h2><blockquote><p>如果对 .NET Web 开发的印象还停留在 <strong>“Windows + IIS + 闭源”</strong> 的时代，是时候更新了。</p></blockquote><p><strong>ASP.NET Core (基于 .NET 5&#x2F;6&#x2F;7&#x2F;8) 的本质：</strong></p><pre><code class="plaintext">✅ 完全开源✅ 真正跨平台 (Win/Linux/macOS)✅ 高性能模块化设计✅ 云原生/微服务优先它提供：一流的开发体验（C# 强类型 + 成熟工具链）出色的运行时性能深度融入 Linux/容器为核心的现代基础设施生态所以下次技术选型时，咱也可以考虑一下AspNetCore。</code></pre>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构笔记</title>
      <link href="/2024/12/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AC%94%E8%AE%B0/"/>
      <url>/2024/12/13/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><p>目录：<br>第1章 绪论</p><p>1.1 什么是数据结构<br>1.1.1 数据结构的定义<br>1.1.2 逻辑结构<br>1.1.3 存储结构<br>1.1.4 数据运算<br>1.1.5 数据类型和抽象数据类型<br>1.2 算法及其描述<br>1.2.1 什么是算法<br>1.2.2 算法设计的目标<br>1.2.3 算法描述<br>1.3 算法分析<br>1.3.1 算法分析概述<br>1.3.2 算法时间性能分析<br>1.3.3 算法空间性能分析<br>1.4 数据结构+算法&#x3D;程序<br>1.4.1 程序和数据结构<br>1.4.2 算法和程序<br>1.4.3 算法和数据结构<br>1.4.4 数据结构的发展<br>第2章 线性表</p><p>2.1 线性表及其逻辑结构<br>2.2 线性表的顺序存储结构<br>2.3 线性表的链式存储结构<br>2.4 线性表的应用<br>第3章 栈和队列</p><p>3.1 栈<br>3.2 队列<br>第4章 串</p><p>4.1 串的概念与模式匹配算法<br>第5章 递归</p><p>5.1 递归算法的设计方法<br>第6章 数组和广义表</p><p>6.1 数组<br>6.2 稀疏矩阵<br>6.3 广义表<br>第7章 树和二叉树</p><p>7.1 树<br>7.2 二叉树<br>7.3 树和森林<br>第8章 图</p><p>8.1 图的概念<br>8.2 图的存储结构<br>8.3 图的遍历<br>8.4 图的特殊应用<br>第9章 查找</p><p>9.1 查找算法的实现<br>第10章 内排序</p><p>10.1 内排序算法的实现<br>第11章 外排序</p><p>11.1 外排序算法的实现</p><p>下载链接：<a href="https://www.hostize.com/zh/v/ssWxJPtpmI">https://www.hostize.com/zh/v/ssWxJPtpmI</a></p>]]></content>
      
      
      <categories>
          
          <category> 文件下载 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>发现一个不错的使用前端的AIV0.dev</title>
      <link href="/2024/11/29/%E5%8F%91%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%B8%8D%E9%94%99%E7%9A%84%E4%BD%BF%E7%94%A8%E5%89%8D%E7%AB%AF%E7%9A%84AIV0-dev/"/>
      <url>/2024/11/29/%E5%8F%91%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%B8%8D%E9%94%99%E7%9A%84%E4%BD%BF%E7%94%A8%E5%89%8D%E7%AB%AF%E7%9A%84AIV0-dev/</url>
      
        <content type="html"><![CDATA[<div class="video-container">[up主专用，视频内嵌代码贴在这]</div><style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style>]]></content>
      
      
      <categories>
          
          <category> 前端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ORM框架EntityFramework在ASP.NetCoreAPI中的应用</title>
      <link href="/2024/11/21/ORM%E6%A1%86%E6%9E%B6EntityFramework%E5%9C%A8ASP-NetCoreAPI%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/"/>
      <url>/2024/11/21/ORM%E6%A1%86%E6%9E%B6EntityFramework%E5%9C%A8ASP-NetCoreAPI%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h3 id="什么是EntityFrameworkCore？"><a href="#什么是EntityFrameworkCore？" class="headerlink" title="什么是EntityFrameworkCore？"></a>什么是EntityFrameworkCore？</h3><p>   EntityFramework Core 是微软推出的一个基于.Net Core 的轻量级ORM框架。ORM能够处理数据库与高级编程语言中<br>对象之间的映射关系，它能够将程序中的对象自动持久化到关系型数据库中，并能够将数据库中的数据信息自动映射到编<br>程语言中的对象，从而无须开发人员直接写SQL语句，使用EFCore能够明显的提高开发效率。关系型数据库的数据是存储在<br>由行和列组成的二维表格中，EFCore 在进行关系映射时，.Net 对象 与关系型数据库的构成元素有着一一对应的关系，注意<br>EFCore在应用程序与数据库之间起一个桥梁的作用。</p><table><thead><tr><th>.Net对象</th><th>关系型数据库</th></tr></thead><tbody><tr><td>类</td><td>表</td></tr><tr><td>类的属性</td><td>列</td></tr><tr><td>.Net集合中的元素</td><td>行</td></tr><tr><td>int ID</td><td>主键</td></tr><tr><td>对其他类的引用</td><td>外键</td></tr></tbody></table><p>主键一般都是int型，唯一，由数据库自动生成。</p><h3 id="EFCore的使用"><a href="#EFCore的使用" class="headerlink" title="EFCore的使用"></a>EFCore的使用</h3><p>   EFCore有两种使用方法：第一种是代码优先，第二种是数据库优先。代码优先是指EFcore能够利用先创建好的实体类<br>创建数据库和表；而数据库优先则相反是利用先创建好的数据库和表生成与之匹配的实体类。</p><p>要使用代码优先，必须先创建一个实体类</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">namespace AspApi02NOmvc.Models</span><br><span class="line">&#123;</span><br><span class="line">    public class UserModel</span><br><span class="line">    &#123;</span><br><span class="line">        public int Id &#123; get; set; &#125;//主键</span><br><span class="line">        public string? UserName &#123; get; set; &#125;</span><br><span class="line">        public string? PassWord &#123; get; set; &#125;</span><br><span class="line">        public string? UserMail &#123; get; set; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><code>创建实体类后就需要了解一个类DbContext。</code></pre><p> DbContext位于Microsoft.EntityFrameworkCore命名空间下，代表程序与数据库之间会话或数据上下文，使用它能够<br> 完成查询和保存等操作;在程序中使用EFCore时，需要创建一个DbContext的派生类，在派生类中添加一个或<br> 若干个DbSet<Entity>类型的公共属性，这些属性表示相应实体的集合，对它们的操作最终会反映到数据库中的数据表。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class DataContext:DbContext</span><br><span class="line">&#123;</span><br><span class="line">    public DataContext(DbContextOptions&lt;DataContext&gt; options) : base(options)//构造函数</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    public DbSet&lt;UserModel&gt; UserModels &#123; get; set; &#125;//实体集合</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><pre><code>在appsettings.json中配置默认连接字符串,注意添加进去是否加 “,” 。json格式末尾键值对不加 “,” 。</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&quot;ConnectionStrings&quot;: &#123;</span><br><span class="line">  &quot;DefaultConnection&quot;: &quot;Server = localhost;DataBase = APIDbTest01;Trusted_Connection = true;TrustServerCertificate = true;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>   然后就需要对EF进行配置。如果版本低于.Net 6.0，需要在Startup中进行配置，使用configureServices和configure方法;<br>在.Net 6.0及其以上版本，Startup 已经合并到program中，所以可以直接在program中添加服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">using Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line">var builder = WebApplication.CreateBuilder(args);</span><br><span class="line"></span><br><span class="line">builder.Services.AddDbContext&lt;DataContext&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.UseSqlServer(builder.Configuration.GetConnectionString(&quot;DefaultConnection&quot;));//这里的连接字符串在配置文件中</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>创建一个控制器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[ApiController]</span><br><span class="line">[Route(&quot;api/[controller]&quot;)]</span><br><span class="line">public class LoginController : Controller</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  private readonly DataContext _dataContext;</span><br><span class="line"></span><br><span class="line">      public LoginController(DataContext dataContext)</span><br><span class="line">          &#123;</span><br><span class="line">              _dataContext = dataContext;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">  [HttpPost(&quot;RegUser&quot;)]</span><br><span class="line">  public async Task &lt;ActionResult&gt; RegUser([FromForm]UserModel userModel)</span><br><span class="line">  &#123;</span><br><span class="line">      if (!ModelState.IsValid)&#123;return BadRequest(&quot;模型验证失败&quot;);&#125;</span><br><span class="line">      var user = new UserModel</span><br><span class="line">          &#123; //这里没让Id = userModel.Id 是因为Id是主键，应该让数据库自动生成。</span><br><span class="line">          UserName = userModel.UserName,</span><br><span class="line">          PassWord = userModel.PassWord,</span><br><span class="line">          UserMail = userModel.UserMail,</span><br><span class="line">          &#125;;</span><br><span class="line">      _dataContext.UserModels.Add(user);</span><br><span class="line">      await _dataContext.SaveChangesAsync();</span><br><span class="line">      return Ok(&quot;添加成功&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><pre><code>最后在程序包管理器控制台中使用命令Add-Migration 和Update-DataBase就可以完成数据库的迁移和数据库的创建。</code></pre><p>然后就可以运行API并创建数据了：</p><p><img src="https://img.picgo.net/2024/11/21/-2024-11-21-11211246b9175ff1ba561a.png" alt="屏幕截图 2024 11 21 112112"></p><p>如果使用postman调用api，需要注意传参，因为使用了[FromForm]特性，接收from表单，postman的传参设置为：</p><p><img src="https://img.picgo.net/2024/11/21/-2024-11-21-1110221a4570838089cef20.png" alt="屏幕截图 2024 11 21 111022(1)"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AspNetCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>粘包半包的解决方法</title>
      <link href="/2024/11/05/%E7%B2%98%E5%8C%85%E5%8D%8A%E5%8C%85%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
      <url>/2024/11/05/%E7%B2%98%E5%8C%85%E5%8D%8A%E5%8C%85%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h3 id="什么是粘包？"><a href="#什么是粘包？" class="headerlink" title="什么是粘包？"></a>什么是粘包？</h3><pre><code> 是指如果当发送端快速发送多条数据，但是接收端没有及时调用Receive，那么数据会在接收端的缓存中积累。</code></pre><p>例如：当发送端先发送“1，2，3，4”四个字节，紧接着又发送“5，6，7，8”四个字节的数据；等到接收端调用Receive的<br>时候，接收端的操作系统已经将接收到的全部数据写入缓存区，共接收到“8”个字节。</p><h3 id="什么是半包？"><a href="#什么是半包？" class="headerlink" title="什么是半包？"></a>什么是半包？</h3><pre><code> 也就是当发送端发送的数据太长了，但是接收端的缓存区没有足够的空间接收全部数据，就会接收一部分数据，另一</code></pre><p>部分等下一次调用Receive的时候在接收。<br>例如：发送端发送：asdfghjkl，但是接收端只剩下三个字节的空间，此时接收端接收“asd”，等到下一次调用Receive时再<br>接收fghjkl。</p><h3 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h3><h4 id="一-长度信息法："><a href="#一-长度信息法：" class="headerlink" title="一.长度信息法："></a>一.长度信息法：</h4><pre><code> 在每一个数据包前面加上长度信息，每次接收到数据包后先读取表示长度的字节，如果缓存区的数据长度大于要取的字</code></pre><p>节数，则取出相应的字节，否则等待下一次数据接收。</p><h4 id="二-固定长度法："><a href="#二-固定长度法：" class="headerlink" title="二.固定长度法："></a>二.固定长度法：</h4><pre><code> 每次都以固定的长度发送数据，若大小 “小于” 固定长度，则可以填入一些事先约定的符合占位凑数。</code></pre><h4 id="三-结束符号法："><a href="#三-结束符号法：" class="headerlink" title="三.结束符号法："></a>三.结束符号法：</h4><pre><code> 规定一个结束符号，作为消息间的分隔符；将每次接收到的消息字节，通过结束符分开。</code></pre><p>例如：规定一个结束符为“$” ；若接收到一条消息字节为“Helloworld$Iam”,则接收端先处理数据“Helloworld”，保留“Iam”<br>等到下一个“$”出现，将“Iam”和下一个“$”之间的数据粘在一起，作为一条完整的消息。</p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在C#中操作SQLserver数据库</title>
      <link href="/2024/11/04/%E5%9C%A8C-%E4%B8%AD%E6%93%8D%E4%BD%9CSQLserver%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
      <url>/2024/11/04/%E5%9C%A8C-%E4%B8%AD%E6%93%8D%E4%BD%9CSQLserver%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h2 id="创建C-“控制台应用（-net-framework）”"><a href="#创建C-“控制台应用（-net-framework）”" class="headerlink" title="创建C#“控制台应用（.net framework）”"></a>创建C#“控制台应用（.net framework）”</h2><h3 id="注意项目名为CsToSqlTest02，或者自行去改变命名空间。"><a href="#注意项目名为CsToSqlTest02，或者自行去改变命名空间。" class="headerlink" title="注意项目名为CsToSqlTest02，或者自行去改变命名空间。"></a>注意项目名为CsToSqlTest02，或者自行去改变命名空间。</h3><pre><code>  这段代码是一个C#控制台应用程序，它允许用户通过命令行界面与一个SQL Server数据库进行交互。程序提供了两个主要功能：向数据库插入数据（INSERT）和从数据库查询数据（SELECT）。</code></pre><h4 id="完整代码如下："><a href="#完整代码如下：" class="headerlink" title="完整代码如下："></a>完整代码如下：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Data.SqlClient;</span><br><span class="line">using System.Data;</span><br><span class="line">namespace CsToSqlTest02</span><br><span class="line">&#123;</span><br><span class="line">    internal class Program</span><br><span class="line">    &#123;</span><br><span class="line">            private static string ServeToDateBase = &quot;Server = localhost;DataBase = TestData02x01;Trusted_Connection = true;&quot;;//连接字符串，用于连接数据库</span><br><span class="line">            static string sqlSTR; //= $&quot;insert into UserDataTable_1(userid,userkeyword,username) values(&#x27;&#123;userid&#125;&#x27;,&#x27;&#123;userkeyword&#125;&#x27;,&#x27;&#123;username&#125;&#x27;)&quot;;</span><br><span class="line">            static string userid ;</span><br><span class="line">            static string userkeyword ;</span><br><span class="line">            static string username ;</span><br><span class="line">       </span><br><span class="line">         static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            string a;</span><br><span class="line">            Console.WriteLine(&quot;输入INSERT在数据库插入数据，输入SELECT查看数据库数据&quot;);</span><br><span class="line">            a = Console.ReadLine();</span><br><span class="line">            if (a == &quot;INSERT&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                CR();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (a == &quot;SELECT&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                CK();        </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (a != &quot;INSERT&quot; &amp;&amp; a != &quot;SELECT&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;指令错误&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;按任意键关闭&quot;);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void CR() </span><br><span class="line">        &#123;</span><br><span class="line">            string a;</span><br><span class="line">            Console.WriteLine(&quot;请输入ID，keyword，name&quot;);</span><br><span class="line">            userid = Console.ReadLine();</span><br><span class="line">            userkeyword = Console.ReadLine();</span><br><span class="line">            username = Console.ReadLine();</span><br><span class="line">            sqlSTR = $&quot;insert into UserDataTable_1(userid,userkeyword,username) values(&#x27;&#123;userid&#125;&#x27;,&#x27;&#123;userkeyword&#125;&#x27;,&#x27;&#123;username&#125;&#x27;)&quot;;</span><br><span class="line">            InsertSQLDateBase(sqlSTR);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;按SELECT进行查看，按INSERT继续进行插入,按C退出操作&quot;);</span><br><span class="line">            a = Console.ReadLine();</span><br><span class="line">            if (a == &quot;SELECT&quot;) &#123; CK(); &#125;</span><br><span class="line">            if (a == &quot;INSERT&quot;) &#123; CR(); &#125;</span><br><span class="line">            if(a == &quot;C&quot;) &#123; return; &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void CK() </span><br><span class="line">        &#123;</span><br><span class="line">            string a;</span><br><span class="line"></span><br><span class="line">            sqlSTR = &quot;select * from UserDataTable_1&quot;;</span><br><span class="line">            SelectSQLDateBase(sqlSTR);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;按SELECT进行查看，按INSERT继续进行插入,按C退出操作&quot;);</span><br><span class="line">            a = Console.ReadLine();</span><br><span class="line">            if (a == &quot;SELECT&quot;) &#123; CK(); &#125;</span><br><span class="line">            if (a == &quot;INSERT&quot;) &#123; CR(); &#125;</span><br><span class="line">            if (a == &quot;C&quot;) &#123; return; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public static void InsertSQLDateBase(string sqlSTR)</span><br><span class="line">        &#123;</span><br><span class="line">            SqlConnection conn = new SqlConnection();</span><br><span class="line">            conn.ConnectionString = ServeToDateBase;</span><br><span class="line">            conn.Open();</span><br><span class="line"></span><br><span class="line">            SqlCommand cmd = new SqlCommand(sqlSTR, conn);</span><br><span class="line">            int result = cmd.ExecuteNonQuery();</span><br><span class="line">            if (result &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine($&quot;执行新增语句,受影响的行数&#123;result&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            conn.Close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void SelectSQLDateBase(string sqlSTR) </span><br><span class="line">        &#123;</span><br><span class="line">        SqlConnection con = new SqlConnection();</span><br><span class="line">            con.ConnectionString = ServeToDateBase;</span><br><span class="line">            con.Open();</span><br><span class="line"></span><br><span class="line">        SqlCommand cmd = new SqlCommand(sqlSTR, con);</span><br><span class="line">            SqlDataAdapter adapter = new SqlDataAdapter();</span><br><span class="line">            adapter.SelectCommand = cmd;</span><br><span class="line"></span><br><span class="line">        DataSet ds = new DataSet();</span><br><span class="line">           adapter.Fill(ds);</span><br><span class="line">            con.Close();</span><br><span class="line">            DataTable dt = ds.Tables[0];</span><br><span class="line">            for (int i = 0; i &lt; dt.Rows.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine($&quot;&#123;dt.Rows[i][&quot;userid&quot;]&#125;  &#123;dt.Rows[i][&quot;userkeyword&quot;]&#125;  &#123;dt.Rows[i][&quot;username&quot;]&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="一：连接字符串和变量声明"><a href="#一：连接字符串和变量声明" class="headerlink" title="一：连接字符串和变量声明"></a>一：连接字符串和变量声明</h3><pre><code> 这里定义了数据库连接字符串ServeToDateBase，它包含了服务器地址、数据库名和连接方式（这里使用的是Windows身份验证）。 同时声明了三个静态字符串变量用于存储用户输入的ID、关键词和名称，以及一个用于构建SQL语句的字符串变量sqlSTR。</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static string ServeToDateBase = &quot;Server = localhost;DataBase = TestData02x01;Trusted_Connection = true;&quot;;//连接字符串，用于连接数据库</span><br><span class="line">static string sqlSTR; //= $&quot;insert into UserDataTable_1(userid,userkeyword,username) values(&#x27;&#123;userid&#125;&#x27;,&#x27;&#123;userkeyword&#125;&#x27;,&#x27;&#123;username&#125;&#x27;)&quot;;</span><br><span class="line">static string userid ;</span><br><span class="line">static string userkeyword ;</span><br><span class="line">static string username ;</span><br></pre></td></tr></table></figure><h3 id="二：插入数据库方法（InsertSQLDateBase）"><a href="#二：插入数据库方法（InsertSQLDateBase）" class="headerlink" title="二：插入数据库方法（InsertSQLDateBase）"></a>二：插入数据库方法（InsertSQLDateBase）</h3><pre><code> InsertSQLDateBase方法使用提供的SQL语句打开数据库连接，执行插入操作，并根据受影响的行数给出反馈。</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static void InsertSQLDateBase(string sqlSTR)</span><br><span class="line">  &#123;</span><br><span class="line">      SqlConnection conn = new SqlConnection();</span><br><span class="line">      conn.ConnectionString = ServeToDateBase;</span><br><span class="line">      conn.Open();</span><br><span class="line"></span><br><span class="line">      SqlCommand cmd = new SqlCommand(sqlSTR, conn);</span><br><span class="line">      int result = cmd.ExecuteNonQuery();</span><br><span class="line">      if (result &gt; 0)</span><br><span class="line">          &#123;</span><br><span class="line">              Console.WriteLine($&quot;执行新增语句,受影响的行数&#123;result&#125;&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">      conn.Close();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="三：查询数据库方法（SelectSQLDateBase）"><a href="#三：查询数据库方法（SelectSQLDateBase）" class="headerlink" title="三：查询数据库方法（SelectSQLDateBase）"></a>三：查询数据库方法（SelectSQLDateBase）</h3><pre><code>  SelectSQLDateBase方法使用提供的SQL语句打开数据库连接，执行查询操作，并将结果填充到DataSet中。  然后关闭连接，并遍历结果集，将每行数据输出到控制台。</code></pre><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public static void SelectSQLDateBase(string sqlSTR) </span><br><span class="line">&#123;</span><br><span class="line">SqlConnection con = new SqlConnection();</span><br><span class="line">    con.ConnectionString = ServeToDateBase;</span><br><span class="line">    con.Open();</span><br><span class="line"></span><br><span class="line">SqlCommand cmd = new SqlCommand(sqlSTR, con);</span><br><span class="line">    SqlDataAdapter adapter = new SqlDataAdapter();</span><br><span class="line">    adapter.SelectCommand = cmd;</span><br><span class="line"></span><br><span class="line">DataSet ds = new DataSet();</span><br><span class="line">   adapter.Fill(ds);</span><br><span class="line">    con.Close();</span><br><span class="line">    DataTable dt = ds.Tables[0];</span><br><span class="line">    for (int i = 0; i &lt; dt.Rows.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine($&quot;&#123;dt.Rows[i][&quot;userid&quot;]&#125;  &#123;dt.Rows[i][&quot;userkeyword&quot;]&#125;  &#123;dt.Rows[i][&quot;username&quot;]&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="在使用SQLserver数据库时可能遇见的问题"><a href="#在使用SQLserver数据库时可能遇见的问题" class="headerlink" title="在使用SQLserver数据库时可能遇见的问题"></a>在使用SQLserver数据库时可能遇见的问题</h2><h3 id="显示无法连接到服务器"><a href="#显示无法连接到服务器" class="headerlink" title="显示无法连接到服务器"></a>显示无法连接到服务器</h3><p> 如下<br> <img src="https://img.picgo.net/2024/11/04/-2024-11-04-2217010e587c3d827bca00.png" alt="屏幕截图 2024 11 04 221701"></p><h3 id="解决方法：找到下面这个界面，也就是SQLsever配置管理器。"><a href="#解决方法：找到下面这个界面，也就是SQLsever配置管理器。" class="headerlink" title="解决方法：找到下面这个界面，也就是SQLsever配置管理器。"></a>解决方法：找到下面这个界面，也就是SQLsever配置管理器。</h3><p> 找到配置管理器中的SQLserver服务</p><p> <img src="https://img.picgo.net/2024/11/04/-2024-11-04-221734fdebf7348b7a997b.png" alt="屏幕截图 2024 11 04 221734"></p><p> 将其全部开启这时再去连接数据库就没问题了。</p><p> 最后附上数据库名称。和数据表名称：</p><p> <img src="https://img.picgo.net/2024/11/04/-2024-11-04-222346b7d000fa61a58ef5.png" alt="屏幕截图 2024 11 04 222346"></p>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQLserver </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在C#中通过QQ邮箱SMTP服务发送邮件</title>
      <link href="/2024/11/04/%E5%9C%A8C-%E4%B8%AD%E9%80%9A%E8%BF%87QQ%E9%82%AE%E7%AE%B1SMTP%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/"/>
      <url>/2024/11/04/%E5%9C%A8C-%E4%B8%AD%E9%80%9A%E8%BF%87QQ%E9%82%AE%E7%AE%B1SMTP%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h2 id="C-与SMTP服务简单应用"><a href="#C-与SMTP服务简单应用" class="headerlink" title="C#与SMTP服务简单应用"></a>C#与SMTP服务简单应用</h2><h3 id="代码如下："><a href="#代码如下：" class="headerlink" title="代码如下："></a>代码如下：</h3><p> 主要是注意记得去开启SMTP服务，和获取授权码（开启服务后，会自动给用户）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Net;</span><br><span class="line">using System.Net.Mail;</span><br><span class="line">class Program</span><br><span class="line">&#123;</span><br><span class="line">    public static string mailLocalAdd ;//发件人邮箱</span><br><span class="line">    public static string SendToMailAdd ;//收件人邮箱</span><br><span class="line">    public static string keyword ;//SMTP授权码</span><br><span class="line">    public static string mailname;//发件人名称</span><br><span class="line"></span><br><span class="line">    static void Main()</span><br><span class="line">    &#123;</span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line">            MailMessage mailMessage = new MailMessage();</span><br><span class="line">            Console.WriteLine(&quot;发件人邮箱：&quot;);</span><br><span class="line">            mailLocalAdd = Console.ReadLine();</span><br><span class="line">            Console.WriteLine(&quot;发件人名称：&quot;);</span><br><span class="line">            mailname = Console.ReadLine();</span><br><span class="line">            Console.WriteLine(&quot;收件人邮箱：&quot;);</span><br><span class="line">            SendToMailAdd = Console.ReadLine();</span><br><span class="line">            Console.WriteLine(&quot;发件人邮箱的SMTP授权码：&quot;);</span><br><span class="line">            keyword = Console.ReadLine();   </span><br><span class="line">            mailMessage.From = new MailAddress(mailLocalAdd, mailname, System.Text.Encoding.UTF8);//asgte 为发件人的地址及名称。</span><br><span class="line">            mailMessage.To.Add(new MailAddress(SendToMailAdd));//收信人地址</span><br><span class="line">            mailMessage.Bcc.Add(new MailAddress(SendToMailAdd));//添加密送人</span><br><span class="line">            mailMessage.Subject = &quot;C#利用QQ邮箱SMTP服务发送邮件&quot;; //这是主题</span><br><span class="line">            mailMessage.SubjectEncoding = System.Text.Encoding.UTF8;</span><br><span class="line">            mailMessage.IsBodyHtml = false; //是否将邮件主体设置为html格式</span><br><span class="line">            Console.WriteLine(&quot;输入邮件正文：&quot;);</span><br><span class="line">            mailMessage.Body = Console.ReadLine();  //这是邮件正文</span><br><span class="line">            mailMessage.BodyEncoding = System.Text.Encoding.UTF8;</span><br><span class="line">            SmtpClient smtpClient = new SmtpClient(&quot;smtp.qq.com&quot;, 587); //QQ邮箱的SMTP服务器域名与端口</span><br><span class="line">            smtpClient.EnableSsl = true;//是否使用ssl加密</span><br><span class="line">            smtpClient.Credentials = new NetworkCredential(mailLocalAdd, keyword);//设置登录凭证，这里的keyword为你的邮箱的SMTP授权码</span><br><span class="line">            smtpClient.Send(mailMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex) &#123; Console.WriteLine(&quot;EX:&quot; + ex.Message); &#125;</span><br><span class="line">        Console.WriteLine(&quot;按任意键关闭……&quot;);</span><br><span class="line">        Console.ReadLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SMTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在C#中通过url获取页面HTML文档</title>
      <link href="/2024/11/04/%E5%9C%A8C-%E4%B8%AD%E9%80%9A%E8%BF%87url%E8%8E%B7%E5%8F%96%E9%A1%B5%E9%9D%A2HTML%E6%96%87%E6%A1%A3/"/>
      <url>/2024/11/04/%E5%9C%A8C-%E4%B8%AD%E9%80%9A%E8%BF%87url%E8%8E%B7%E5%8F%96%E9%A1%B5%E9%9D%A2HTML%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h2 id="这个简单直接上代码"><a href="#这个简单直接上代码" class="headerlink" title="这个简单直接上代码:"></a>这个简单直接上代码:</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Net.Http;</span><br><span class="line">using System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line">class Program</span><br><span class="line">&#123;</span><br><span class="line">    static async Task Main()</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(&quot;输入url地址：&quot;);</span><br><span class="line">        string url = Console.ReadLine(); </span><br><span class="line">        using (HttpClient client = new HttpClient())</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                HttpResponseMessage response = await client.GetAsync(url);</span><br><span class="line">                string content = await response.Content.ReadAsStringAsync();</span><br><span class="line">                Console.WriteLine(content);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (HttpRequestException HRex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;请求失败： &quot; + HRex.Message);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex) </span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;请求失败：&quot; + ex.Message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Console.ReadLine(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="你猜的没错，这篇就是凑数的"><a href="#你猜的没错，这篇就是凑数的" class="headerlink" title="你猜的没错，这篇就是凑数的"></a>你猜的没错，这篇就是凑数的</h4>]]></content>
      
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于C#的TcpSmtpSqlServer的不可名状之物</title>
      <link href="/2024/11/04/%E5%9F%BA%E4%BA%8EC-%E7%9A%84%E7%AE%80%E5%8D%95%E8%BF%9C%E7%A8%8B%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/"/>
      <url>/2024/11/04/%E5%9F%BA%E4%BA%8EC-%E7%9A%84%E7%AE%80%E5%8D%95%E8%BF%9C%E7%A8%8B%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="通过Tcp进行远程连接，SQL-server进行数据存储，QQ邮箱发送注册验证码"><a href="#通过Tcp进行远程连接，SQL-server进行数据存储，QQ邮箱发送注册验证码" class="headerlink" title="通过Tcp进行远程连接，SQL server进行数据存储，QQ邮箱发送注册验证码"></a>通过Tcp进行远程连接，SQL server进行数据存储，QQ邮箱发送注册验证码</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>   本文项目可以，在远程主机上通过客户端与服务端的Tcp连接进行通信，然后利用邮箱发送验证码在服务端完成验证并且注册，当验证在服务端通过后，<br>，服务端将会把用户信息保存在SQL server的数据库中。注意使用QQ在服务端发送消息，需要先在QQ邮箱开启SMTP服务，然后保存授权码。</p><h2 id="步骤一：在VisualStudio中创建一个“控制台应用（-net-framework）”的新项目FWDBx02。"><a href="#步骤一：在VisualStudio中创建一个“控制台应用（-net-framework）”的新项目FWDBx02。" class="headerlink" title="步骤一：在VisualStudio中创建一个“控制台应用（.net framework）”的新项目FWDBx02。"></a>步骤一：在VisualStudio中创建一个“控制台应用（.net framework）”的新项目FWDBx02。</h2><p>   项目命名为：FWDBx02 。包含四个部分：Program.cs(主体);MailSendControls.cs(邮件控制);SQLcontrols.cs(数据库控制);<br>ProtocolControls.cs(验证处理控制)。</p><h3 id="Program-cs代码如下："><a href="#Program-cs代码如下：" class="headerlink" title="Program.cs代码如下："></a>Program.cs代码如下：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Net;</span><br><span class="line">using System.Net.Sockets;</span><br><span class="line"></span><br><span class="line">namespace FWDBx02</span><br><span class="line">&#123;</span><br><span class="line">    internal class Program</span><br><span class="line">    &#123;</span><br><span class="line">        private static List&lt;string&gt; DataList = new List&lt;string&gt;();</span><br><span class="line">        private static string asd;</span><br><span class="line">        private static string userReturn;</span><br><span class="line">        public static string asduserID;</span><br><span class="line">        private static string userID;</span><br><span class="line">        public static string asduserkeyword;</span><br><span class="line">        private static string userkeyword;</span><br><span class="line">        private static string CAPTCHAstr;</span><br><span class="line">        public static string asdsendMAIL;</span><br><span class="line">        private static string sendMAIL;</span><br><span class="line">        public static byte[] receiveBuffer = new byte[1024];</span><br><span class="line">        public static string receiveSTR;</span><br><span class="line">        public static IPAddress ipAddress; </span><br><span class="line">        public static int portINT; </span><br><span class="line">        public static IPEndPoint iPEndPoint;</span><br><span class="line">        public static Socket socket;</span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;这里是服务端：&quot;);</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;输入服务器IP：&quot;);</span><br><span class="line">                ipAddress = IPAddress.Parse(Console.ReadLine());</span><br><span class="line">                Console.WriteLine(&quot;输入开放端口：&quot;);</span><br><span class="line">                portINT = int.Parse(Console.ReadLine());</span><br><span class="line">                iPEndPoint = new IPEndPoint(ipAddress, portINT);</span><br><span class="line">                socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">                socket.Bind(iPEndPoint);</span><br><span class="line"></span><br><span class="line">                socket.Listen(10);</span><br><span class="line">                socket.BeginAccept(AcceptCallback,socket);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;MAINse:&quot;+se.Message); &#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;MAINex:&quot;+ex.Message); &#125;</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static void AcceptCallback(IAsyncResult ar)</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                Socket socket = (Socket)ar.AsyncState;</span><br><span class="line">                Socket clientSocket = socket.EndAccept(ar);</span><br><span class="line">                clientSocket.BeginReceive(receiveBuffer,0,1024,0,ReceiveCallback,clientSocket);</span><br><span class="line">                socket.BeginAccept(AcceptCallback, socket);</span><br><span class="line">            &#125; </span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;ACBse:&quot;+se.Message);&#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;ACBex:&quot;+ex.Message); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static void ReceiveCallback(IAsyncResult ar)</span><br><span class="line">        &#123;</span><br><span class="line">            //try </span><br><span class="line">            //&#123;</span><br><span class="line">                Socket clientSocket = (Socket)ar.AsyncState;</span><br><span class="line">                int con = clientSocket.EndReceive(ar);</span><br><span class="line">                receiveSTR = System.Text.Encoding.UTF8.GetString(receiveBuffer, 0, con);</span><br><span class="line">                Console.WriteLine(receiveSTR);//*</span><br><span class="line">                    ProcessingUSER(receiveSTR);</span><br><span class="line">                ///</span><br><span class="line">                clientSocket.BeginReceive(receiveBuffer, 0, 1024, 0, ReceiveCallback, clientSocket);</span><br><span class="line">            //&#125;</span><br><span class="line">            //catch (SocketException se) &#123; Console.WriteLine(&quot;RCBse:&quot;+se.Message);&#125;</span><br><span class="line">            //catch (Exception ex) &#123; Console.WriteLine(&quot;RCBex:&quot;+ex.Message);&#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static void ProcessingUSER(string receiveSTR) </span><br><span class="line">        &#123;</span><br><span class="line">            ProtocolControls protocolControls = new ProtocolControls(receiveSTR);</span><br><span class="line">            CAPTCHAstr = protocolControls.captchaSTR;//用户发送信息第一波产生的验证码</span><br><span class="line">            asd = CAPTCHAstr;</span><br><span class="line">            sendMAIL = protocolControls.SENDMAIL;</span><br><span class="line">            asdsendMAIL = sendMAIL;</span><br><span class="line">            userID = protocolControls.USRID; </span><br><span class="line">            asduserID = userID;</span><br><span class="line">            userkeyword = protocolControls.USRKEYWORD;</span><br><span class="line">            asduserkeyword = userkeyword;</span><br><span class="line">            DataList.Add(asduserID);</span><br><span class="line">            DataList.Add(asduserkeyword);</span><br><span class="line">            DataList.Add(asdsendMAIL);</span><br><span class="line">            //DataList.Add(CAPTCHAstr);</span><br><span class="line">            Console.WriteLine($&quot;&#123;asduserID&#125; &#123;asduserkeyword&#125; &#123;asdsendMAIL&#125;&quot;);</span><br><span class="line">            //222222/1234565/3623461767@qq.com</span><br><span class="line">            if (CAPTCHAstr != null) </span><br><span class="line">            &#123;   </span><br><span class="line">                userReturn = protocolControls.USRRETURN;</span><br><span class="line">                </span><br><span class="line">                MailSendControls mailSendControls = new MailSendControls(sendMAIL, CAPTCHAstr);</span><br><span class="line"></span><br><span class="line">            &#125;else if(userReturn == asd )</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine($&quot;&#123;DataList[0]&#125; &#123;DataList[1]&#125; &#123;DataList[2]&#125;&quot;);</span><br><span class="line">                SQLcontrols sQLcontrols = new SQLcontrols(DataList[0], DataList[1], DataList[2]);        </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="MailSendControls-cs代码如下："><a href="#MailSendControls-cs代码如下：" class="headerlink" title="MailSendControls.cs代码如下："></a>MailSendControls.cs代码如下：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">using System.Net;</span><br><span class="line">using System.Net.Mail;</span><br><span class="line"></span><br><span class="line">namespace FWDBx02</span><br><span class="line">&#123;</span><br><span class="line">    internal class MailSendControls//注册邮件发送</span><br><span class="line">    &#123;</span><br><span class="line">        private static string mailLocalAdd = &quot;你的邮箱&quot;;</span><br><span class="line">        private static string keyword = &quot;SMTP授权码&quot;;</span><br><span class="line">        private static string SendToMailAdd ;</span><br><span class="line">        private static string CAPTCHAstr;</span><br><span class="line">        public MailSendControls(string sendToMailAdd,string captchaSTR) </span><br><span class="line">        &#123;</span><br><span class="line">         SendToMailAdd = sendToMailAdd;</span><br><span class="line">            CAPTCHAstr = captchaSTR;</span><br><span class="line">            MailSend(SendToMailAdd, CAPTCHAstr);</span><br><span class="line">        &#125;</span><br><span class="line">        private void MailSend(string SendToMailAdd, string captchaSTR)</span><br><span class="line">        &#123;</span><br><span class="line">            MailMessage mailMessage = new MailMessage();</span><br><span class="line">            mailMessage.From = new MailAddress(mailLocalAdd, &quot;通信ID注册&quot;, System.Text.Encoding.UTF8);</span><br><span class="line"></span><br><span class="line">            mailMessage.To.Add(new MailAddress(SendToMailAdd));</span><br><span class="line">            mailMessage.Bcc.Add(new MailAddress(SendToMailAdd));</span><br><span class="line">            mailMessage.Subject = &quot;这是邮件的主题&quot;;</span><br><span class="line">            mailMessage.SubjectEncoding = System.Text.Encoding.UTF8;</span><br><span class="line"></span><br><span class="line">            mailMessage.IsBodyHtml = false;</span><br><span class="line">            mailMessage.Body = $&quot;注册验证码：&#123;captchaSTR&#125;&quot;;</span><br><span class="line">            mailMessage.BodyEncoding = System.Text.Encoding.UTF8;</span><br><span class="line"></span><br><span class="line">            SmtpClient smtpClient = new SmtpClient(&quot;smtp.qq.com&quot;, 587);</span><br><span class="line">            smtpClient.EnableSsl = true;</span><br><span class="line">            smtpClient.Credentials = new NetworkCredential(mailLocalAdd, keyword);</span><br><span class="line">            smtpClient.Send(mailMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="SQLcontrols-cs代码如下："><a href="#SQLcontrols-cs代码如下：" class="headerlink" title="SQLcontrols.cs代码如下："></a>SQLcontrols.cs代码如下：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">using System.Data.SqlClient;</span><br><span class="line"></span><br><span class="line">namespace FWDBx02</span><br><span class="line">&#123;</span><br><span class="line">    internal class SQLcontrols//注册信息存入数据库</span><br><span class="line">    &#123;</span><br><span class="line">        //连接字符串</span><br><span class="line">        private static string serverToDateBase = &quot;Server = localhost;DataBase = TestA02x01;Trusted_Connection = true;&quot;;</span><br><span class="line">        //sql语句</span><br><span class="line">        private static string sqlSTR;  </span><br><span class="line">        private static string userid;</span><br><span class="line">        private static string userkeyword;</span><br><span class="line">        private static string usermail;</span><br><span class="line">        public SQLcontrols(string Userid,string Userkeyword,string Usermail)</span><br><span class="line">        &#123;</span><br><span class="line">            sqlSTR = $&quot;insert into userREGTable_1(userid,userkeyword,usermail) values(&#x27;&#123;Userid&#125;&#x27;,&#x27;&#123;Userkeyword&#125;&#x27;,&#x27;&#123;Usermail&#125;&#x27;)&quot;;</span><br><span class="line">            InsertSQLDB(sqlSTR);</span><br><span class="line">        &#125;</span><br><span class="line">        private static void InsertSQLDB (string SqlSTR)</span><br><span class="line">        &#123;</span><br><span class="line">        SqlConnection sqlConnection = new SqlConnection ();</span><br><span class="line">            sqlConnection.ConnectionString = serverToDateBase;//先连接，再打开</span><br><span class="line">            sqlConnection.Open ();</span><br><span class="line"></span><br><span class="line">        SqlCommand cmd = sqlConnection.CreateCommand ();</span><br><span class="line">            cmd.CommandText = sqlSTR;</span><br><span class="line">            cmd.Connection = sqlConnection;</span><br><span class="line">            int resultSQL = cmd.ExecuteNonQuery ();</span><br><span class="line">            sqlConnection.Close ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ProtocolControls-cs代码如下："><a href="#ProtocolControls-cs代码如下：" class="headerlink" title="ProtocolControls.cs代码如下："></a>ProtocolControls.cs代码如下：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line"></span><br><span class="line">namespace FWDBx02</span><br><span class="line">&#123;</span><br><span class="line">    internal class ProtocolControls //协议处理,将账号的注册并入协议处理</span><br><span class="line">    &#123;</span><br><span class="line">        class ProtocolTexts</span><br><span class="line">        &#123;</span><br><span class="line">            public ProtocolTexts() &#123; &#125;</span><br><span class="line">            public string reg = &quot;REG&quot;;</span><br><span class="line">            public string communication = &quot;COMM&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public string captchaSTR;</span><br><span class="line">        public string SENDMAIL;</span><br><span class="line">        public string USRID;</span><br><span class="line">        public string USRKEYWORD;</span><br><span class="line">        public string USRRETURN;</span><br><span class="line"></span><br><span class="line">        private static string receiveSTR;</span><br><span class="line">        char splitSTR = &#x27;/&#x27;;            //通过“/”分割信息</span><br><span class="line">        private static string[] parts;</span><br><span class="line">        private static int partsLength;</span><br><span class="line">        public ProtocolControls(string ReceiveSTR) </span><br><span class="line">        &#123;</span><br><span class="line">            receiveSTR = ReceiveSTR;</span><br><span class="line">            /////</span><br><span class="line">            //扫描接收信息字节是否有恶意（没写）</span><br><span class="line">            /////</span><br><span class="line">            ProtocolProcessing(receiveSTR);</span><br><span class="line">        &#125;</span><br><span class="line">        private void ProtocolProcessing( string receiveSTR) </span><br><span class="line">        &#123;</span><br><span class="line">            ProtocolTexts protocolTexts = new ProtocolTexts();</span><br><span class="line">            parts = receiveSTR.Split(splitSTR); </span><br><span class="line">            partsLength = parts.Length;</span><br><span class="line">           </span><br><span class="line">            if (parts[0] == protocolTexts.reg)</span><br><span class="line">            &#123;</span><br><span class="line">                switch (parts[0])</span><br><span class="line">                &#123;</span><br><span class="line">                    case &quot;REG&quot;: goto ZCZH; ; ;</span><br><span class="line">                    case &quot;COMM&quot;: goto ZHTX; ; ;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        ZCZH:</span><br><span class="line">           </span><br><span class="line">            if (parts[1].Length == 4) </span><br><span class="line">            &#123;</span><br><span class="line">                //SENDMAIL  = parts[3];</span><br><span class="line">                USRRETURN = parts[1];</span><br><span class="line">                captchaSTR = null;////????????????????????????????</span><br><span class="line">                goto PT;</span><br><span class="line">            &#125;</span><br><span class="line">            else </span><br><span class="line">            &#123;</span><br><span class="line">                //USRRETURN = null;</span><br><span class="line">                USRID = parts[1];</span><br><span class="line">                USRKEYWORD = parts[2];</span><br><span class="line">                SENDMAIL = parts[3]; </span><br><span class="line">                Random random = new Random();</span><br><span class="line">                int[] num = new int[4];</span><br><span class="line">                string[] captcha = new string[4];</span><br><span class="line">            </span><br><span class="line">                for (int i = 0; i&lt;4;i++) </span><br><span class="line">                &#123;</span><br><span class="line">                    num[i] = random.Next(0,10); //随机生成数字</span><br><span class="line">                    captcha[i] = num[i].ToString();</span><br><span class="line">                &#125;</span><br><span class="line">                captchaSTR = captcha[0]+captcha[1]+captcha[2]+captcha[3];//这是验证码</span><br><span class="line">            goto PT;</span><br><span class="line">                ; </span><br><span class="line">            &#125;</span><br><span class="line">         </span><br><span class="line">        ZHTX:</span><br><span class="line"></span><br><span class="line">            goto PT;</span><br><span class="line">            ;</span><br><span class="line">        PT:// ZCZH 或者 ZHTX 执行完成 后统一 跳转 到 &quot;PT标签&quot;</span><br><span class="line"></span><br><span class="line">          return  ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="步骤二：创建一个“控制台应用（-net-framework）”的新项目CHDAx02"><a href="#步骤二：创建一个“控制台应用（-net-framework）”的新项目CHDAx02" class="headerlink" title="步骤二：创建一个“控制台应用（.net framework）”的新项目CHDAx02"></a>步骤二：创建一个“控制台应用（.net framework）”的新项目CHDAx02</h2><pre><code>项目命名为CHDAx02。该项目只有一个Program.cs文件，唯一需要注意的是socket的使用，它的Beginsend方法及其回调SendCallback与发送方法send。</code></pre><p>由于这个代码是以前写的，不是用来做这个的，只是稍稍改了一下，所以有多余部分没有修改删除，不过重点注意上一句话的内容就行了。</p><h3 id="Program-cs代码如下：-1"><a href="#Program-cs代码如下：-1" class="headerlink" title="Program.cs代码如下："></a>Program.cs代码如下：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Net.Sockets;</span><br><span class="line">using System.Net;</span><br><span class="line"></span><br><span class="line">namespace CHDAx02</span><br><span class="line">&#123;          </span><br><span class="line">    internal class Program //客户端</span><br><span class="line">    &#123;</span><br><span class="line">        //REGISTRATION:REG(注册请求)</span><br><span class="line">        //COMMUNICATION:COMM(通信请求)</span><br><span class="line">      </span><br><span class="line">        public enum Protocol </span><br><span class="line">        &#123;</span><br><span class="line">          REG = 1110,</span><br><span class="line">          COMM = 1111,</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        static IPAddress iPAddress;</span><br><span class="line">        public static int portINT ;</span><br><span class="line">        static IPEndPoint iPEndPoint ;</span><br><span class="line">        </span><br><span class="line">        public static string receiveSTR;</span><br><span class="line">        public static byte[] sendBuffer;</span><br><span class="line">        public static byte[] receiveBuffer;</span><br><span class="line">        static Socket socket ;</span><br><span class="line">      </span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(&quot;这里是客户端&quot;);</span><br><span class="line">              try </span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;注意输入用户信息时，格式为 用户id/用户密码/用户邮箱 然后回车，只回车一下，然后等待邮箱接受验证码&quot;);</span><br><span class="line">                Console.WriteLine(&quot;当邮箱接收到验证码后，就可以直接在客户端输入验证码然后回车，若验证码正确，注册完成&quot;);</span><br><span class="line">                Console.WriteLine(&quot;输入服务端IP地址：&quot;);</span><br><span class="line">                iPAddress = IPAddress.Parse(Console.ReadLine());</span><br><span class="line">                Console.WriteLine(&quot;输入服务端端口：&quot;);</span><br><span class="line">                portINT = int.Parse(Console.ReadLine());</span><br><span class="line">                Console.WriteLine(&quot;输入用户信息：&quot;);</span><br><span class="line">                iPEndPoint = new IPEndPoint(iPAddress, portINT);</span><br><span class="line">                socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">                socket.BeginConnect(iPEndPoint, ConnectCallback, socket);</span><br><span class="line">                while (true)</span><br><span class="line">                &#123;</span><br><span class="line">                    string asd = Console.ReadLine();</span><br><span class="line">                    Send(Protocol.REG, asd);</span><br><span class="line">                &#125;</span><br><span class="line">                //*发送信息方法</span><br><span class="line">            &#125;</span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;MainSE:&quot;+se.Message); &#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;MainEX:&quot;+ex.Message); &#125;</span><br><span class="line">            </span><br><span class="line">            Console.WriteLine(&quot;按任意键关闭&quot;);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        private static void ConnectCallback(IAsyncResult ar)</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                Socket clientSocket = (Socket)ar.AsyncState;</span><br><span class="line">                clientSocket.EndConnect(ar);</span><br><span class="line">                //注释接收</span><br><span class="line">             //clientSocket.BeginReceive(receiveBuffer,0,receiveBuffer.Length,0,ReceiveCallback,clientSocket);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;CCBse:&quot;+se.Message); &#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;CCBex:&quot;+ex.Message); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static void ReceiveCallback(IAsyncResult ar)</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                Socket clientSocket = (Socket)ar.AsyncState;</span><br><span class="line">                int cont = clientSocket.EndReceive(ar);</span><br><span class="line">                receiveSTR = System.Text.Encoding.UTF8.GetString(receiveBuffer, 0, cont);</span><br><span class="line">                Console.WriteLine(receiveSTR);//*</span><br><span class="line">                clientSocket.BeginReceive(receiveBuffer, 0, receiveBuffer.Length, 0, ReceiveCallback, clientSocket);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;RCBse:&quot; + se.Message); &#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;RCBex:&quot;+ex.Message); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void Send(Protocol protocol,string UserSendSTR) //手动调用//约定协议，协议全部大写</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                string sendData = protocol + &quot;/&quot; + UserSendSTR;</span><br><span class="line">                sendBuffer = System.Text.Encoding.UTF8.GetBytes(sendData);</span><br><span class="line">                socket.BeginSend(sendBuffer, 0, sendBuffer.Length, 0, SendCallback, socket);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;SendSE:&quot; + se.Message); &#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;SendSE:&quot;+ex.Message); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static void SendCallback(IAsyncResult ar)</span><br><span class="line">        &#123;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                Socket socket = (Socket)ar.AsyncState;</span><br><span class="line">                int cont = socket.EndSend(ar);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (SocketException se) &#123; Console.WriteLine(&quot;SCBse:&quot; + se.Message); &#125;</span><br><span class="line">            catch (Exception ex) &#123; Console.WriteLine(&quot;SCBex:&quot;+ex.Message); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="步骤三：如果就只是在本机的端口上使用，那么已经完成。如果想两台电脑远程访问，需要结合路由器的端口映射和cpolar创建隧道，进行进行内网穿透。"><a href="#步骤三：如果就只是在本机的端口上使用，那么已经完成。如果想两台电脑远程访问，需要结合路由器的端口映射和cpolar创建隧道，进行进行内网穿透。" class="headerlink" title="步骤三：如果就只是在本机的端口上使用，那么已经完成。如果想两台电脑远程访问，需要结合路由器的端口映射和cpolar创建隧道，进行进行内网穿透。"></a>步骤三：如果就只是在本机的端口上使用，那么已经完成。如果想两台电脑远程访问，需要结合路由器的端口映射和cpolar创建隧道，进行进行内网穿透。</h2><h3 id="当你完成端口映射和隧道创建后："><a href="#当你完成端口映射和隧道创建后：" class="headerlink" title="当你完成端口映射和隧道创建后："></a>当你完成端口映射和隧道创建后：</h3><pre><code>拥有FWDBx02 项目的作服务端，在输入ip是，应该是你的内网ip，即在cmd中ipconfig看到的ip地址。而CHDAx02项目则是需要发送给客户端，这里输入的ip应该是路由器的公网ip，需要注意端口要统一。原理：当客户端访问 路由器公网ip:端口 时，因为有端口映射，所以路由器会把该端口的访问转发到映射的内网ip上的端口上，就完成了通信。</code></pre><h2 id="代码很粗糙，我知道，这只是我的一个学习记录而已。"><a href="#代码很粗糙，我知道，这只是我的一个学习记录而已。" class="headerlink" title="代码很粗糙，我知道，这只是我的一个学习记录而已。"></a>代码很粗糙，我知道，这只是我的一个学习记录而已。</h2>]]></content>
      
      
      <categories>
          
          <category> 后端开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>路由器端口映射与cpolar内网穿透</title>
      <link href="/2024/11/03/%E6%96%B0%E6%96%87%E7%AB%A0/"/>
      <url>/2024/11/03/%E6%96%B0%E6%96%87%E7%AB%A0/</url>
      
        <content type="html"><![CDATA[<style>.video-container {    position: relative;    width: 100%;    padding-top: 56.25%; /* 16:9 aspect ratio (height/width = 9/16 * 100%) */}.video-container iframe {    position: absolute;    top: 0;    left: 0;    width: 100%;    height: 100%;}</style><h1 id="通过端口映射和隧道技术实现内网穿透"><a href="#通过端口映射和隧道技术实现内网穿透" class="headerlink" title="通过端口映射和隧道技术实现内网穿透"></a>通过端口映射和隧道技术实现内网穿透</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在现代网络环境中，我们经常需要从外部网络访问内网资源。本文将介绍如何通过在路由器中设置端口映射，并使用cpolar创建隧道，来实现从外网访问内网中的私人电脑网站文件。</p><h2 id="步骤一：设置端口映射和创建隧道"><a href="#步骤一：设置端口映射和创建隧道" class="headerlink" title="步骤一：设置端口映射和创建隧道"></a>步骤一：设置端口映射和创建隧道</h2><p>首先，我们需要在路由器中添加一个端口映射。这一步骤将外网的端口映射到内网特定设备的特定端口上。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 登录到你的路由器管理界面。</span><br><span class="line">2. 找到“端口映射”或“端口转发”的设置选项。</span><br><span class="line">3. 添加一个新的端口映射规则，指定：</span><br><span class="line">   - 外部端口（你希望从外网访问的端口）</span><br><span class="line">   - 内部IP地址（你的私人电脑的内网IP）</span><br><span class="line">   - 内部端口（你的私人电脑监听的端口，一般情况下与外部端口相同）</span><br></pre></td></tr></table></figure><h2 id="步骤二：使用cpolar创建隧道"><a href="#步骤二：使用cpolar创建隧道" class="headerlink" title="步骤二：使用cpolar创建隧道"></a>步骤二：使用cpolar创建隧道</h2> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 在你的私人电脑上安装并运行cpolar。</span><br><span class="line">2. 按照cpolar的指引，设置隧道，使用以下参数：</span><br><span class="line">   - 公网IP：你的路由器的公网IP地址</span><br><span class="line">   - 公网端口：你之前在路由器中设置的外部端口</span><br><span class="line">3. 启动隧道，cpolar将生成一个网址，用于外网访问。</span><br></pre></td></tr></table></figure><h2 id="步骤三：访问你的私人网站"><a href="#步骤三：访问你的私人网站" class="headerlink" title="步骤三：访问你的私人网站"></a>步骤三：访问你的私人网站</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- 在浏览器中输入cpolar提供的网址，你将能够看到你的私人网站上的内容。</span><br><span class="line">- 这里需要注意的问题主要是 你自己的网站是否有SSL/TLS证书；如果没有，就使用http 开头的网址访问（cpolar提供网址）。</span><br></pre></td></tr></table></figure><h2 id="可能出现的问题：Cpolar-Web-UI可能无法登录。"><a href="#可能出现的问题：Cpolar-Web-UI可能无法登录。" class="headerlink" title="可能出现的问题：Cpolar Web UI可能无法登录。"></a>可能出现的问题：Cpolar Web UI可能无法登录。</h2><p> 直接在计算机菜单栏里搜索“服务”，找到“Cpolar Service”。然后打开就行了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2024/11/03/hello-world/"/>
      <url>/2024/11/03/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
